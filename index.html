<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>천금문 (千金門) - 단순화 및 고속화 버전</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ------------------------------------------------------------------
        // 1. Supabase 설정 및 초기화
        // ------------------------------------------------------------------
        // NOTE: 새로운 주소 및 키로 업데이트되었습니다.
        const SUPABASE_URL = 'https://cpssatqtodlplwgskfin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwc3NhdHF0b2RscGx3Z3NrZmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1Njg5MzUsImV4cCI6MjA4MTE0NDkzNX0.C5_6TRHvyEBbPcO3_FOh_WyMnAkhswOiBqxDUeKrV0I';
        const STORAGE_BUCKET = 'images'; // 이미지 버킷명

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ------------------------------------------------------------------
        // 2. 전역 상태 및 상수
        // ------------------------------------------------------------------
        
        // Supabase 인증 상태를 추적하기 위한 플래그
        let isAuthenticating = false;

        const state = {
            user: null,
            profile: null,
            currentPostId: null,
            postToEdit: null,
            isEditing: false,
            currentStockName: '삼성전자', 
            stockTags: [], 
            realtimeChannels: {},
            guestName: `나그네_${Math.floor(Math.random() * 1000)}`,
        };
        
        const ADMIN_EMAIL = 'salad20c@gmail.com'; // 관리자 이메일 (삭제 권한 부여)

        const LEVEL_NAMES = ['입문자', '초학자', '시세견습', '기문초해', '자본내공가', '강호시세객', '전략비급사', '시장현경', '초절정투객', '절세투자고수', '금룡장문'];
        
        const MU_GONG_TYPES = [
            { id: 'sword', name: '질풍검법 (단기)', tag: '단기', color: 'text-red-500' },
            { id: 'dao', name: '태극도법 (장기)', tag: '장기', color: 'text-blue-500' },
            { id: 'auto', name: '오토진법 (자동)', tag: '자동', color: 'text-yellow-500' },
        ];
        
        // ------------------------------------------------------------------
        // 3. 유틸리티 및 인증 함수
        // ------------------------------------------------------------------
        
        function isAdmin() {
            // 현재 로그인한 사용자가 관리자 이메일과 일치하는지 확인
            return state.user && state.user.email === ADMIN_EMAIL;
        }
        
        /**
         * 사용자에게 메시지를 보여주는 토스트 알림 함수
         * @param {string} message - 표시할 메시지
         * @param {string} type - 'success' 또는 'error'
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const messageElement = document.getElementById('toast-message');
            
            toast.classList.remove('hidden', 'bg-red-600', 'bg-green-600');
            
            if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-green-600');
            }
            
            messageElement.innerText = message;

            // 3초 후 사라지도록 설정
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function calculateLevel(postCount, commentCount) {
            const score = (postCount || 0) + (commentCount || 0);
            const idx = Math.min(Math.floor(score / 10), LEVEL_NAMES.length - 1);
            return { name: LEVEL_NAMES[idx], color: idx > 5 ? 'text-yellow-400' : 'text-cyan-400' };
        }

        async function handleAuth(isSignUp) {
            if (isAuthenticating) return;
            isAuthenticating = true;
            
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const confirmPassword = document.getElementById('auth-confirm-password').value;
            
            if (!email || !password) {
                showToast('이메일과 비밀번호를 입력해주세요.', 'error');
                isAuthenticating = false;
                return;
            }
            
            // 회원가입 시 비밀번호 일치 및 약관 동의 확인
            if (isSignUp) {
                const termsChecked = document.getElementById('auth-terms').checked;
                
                if (password !== confirmPassword) {
                    showToast('비밀번호와 확인 비밀번호가 일치하지 않습니다.', 'error');
                    isAuthenticating = false;
                    return;
                }
                
                if (!termsChecked) {
                    showToast('이용 약관 및 개인정보 처리 방침에 동의해야 합니다.', 'error');
                    isAuthenticating = false;
                    return;
                }
            }

            let error;
            try {
                if (isSignUp) {
                    ({ error } = await client.auth.signUp({ email, password }));
                } else {
                    ({ error } = await client.auth.signInWithPassword({ email, password }));
                }
            } catch (e) {
                error = e;
            }

            if (error) {
                console.error(`인증 실패: ${error.message}`);
                showToast(`인증 실패: ${error.message}`, 'error');
            } else {
                if (isSignUp) {
                    showToast('성공적으로 문파에 입문했습니다! 이메일 확인이 필요할 수 있습니다.', 'success');
                } else {
                    showToast('성공적으로 로그인했습니다!', 'success');
                }
                closeModal('authModal');
                checkSession();
            }
            isAuthenticating = false;
        }
        
        async function logout() {
            await client.auth.signOut();
            state.profile = null;
            state.user = null;
            updateHeaderUI();
            navigate('gangho-plaza');
            showToast('하산했습니다.', 'success');
        }

        async function checkSession() {
            const { data: { session } } = await client.auth.getSession();
            updateAuthState(session);
            client.auth.onAuthStateChange((_event, session) => updateAuthState(session));
        }

        async function updateAuthState(session) {
            state.user = session ? session.user : null;
            if (state.user) {
                // 프로필 조회 및 상태 업데이트
                const { data } = await client.from('profiles').select('*').eq('id', state.user.id).single();
                if (data) state.profile = data;
                else state.profile = { nickname: '새로운 문도', post_count: 0, comment_count: 0 }; // 프로필이 없을 경우 기본값
            } else {
                state.profile = null;
            }
            updateHeaderUI();
        }

        // 로그인/회원가입 뷰 전환 (비밀번호 확인 및 약관 동의 필드 표시/숨김)
        window.toggleAuthView = function(isSignUp) {
            const signUpFields = document.getElementById('signup-fields');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            
            if (isSignUp) {
                signUpFields.classList.remove('hidden');
                loginBtn.classList.remove('bg-yellow-600', 'text-white', 'font-bold');
                loginBtn.classList.add('bg-gray-700', 'text-gray-300');
                signupBtn.classList.add('bg-green-600', 'text-white', 'font-bold');
                signupBtn.classList.remove('bg-gray-700', 'text-gray-300');
            } else {
                signUpFields.classList.add('hidden');
                loginBtn.classList.add('bg-yellow-600', 'text-white', 'font-bold');
                loginBtn.classList.remove('bg-gray-700', 'text-gray-300');
                signupBtn.classList.remove('bg-green-600', 'text-white', 'font-bold');
                signupBtn.classList.add('bg-gray-700', 'text-gray-300');
            }
        }
        
        function updateHeaderUI() {
            const authContainer = document.getElementById('auth-buttons');
            if (state.user && state.profile) {
                const level = calculateLevel(state.profile.post_count, state.profile.comment_count);
                authContainer.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-400 hidden sm:inline">레벨: <span class="${level.color} font-bold">${level.name}</span></span>
                        <span class="text-xs text-gray-400 hidden sm:inline">환영합니다, <span class="text-yellow-400 font-bold">${state.profile.nickname || '문도'}</span>님</span>
                        <button onclick="logout()" class="text-xs bg-red-900/50 text-red-200 px-3 py-1 rounded hover:bg-red-900 transition">하산</button>
                    </div>
                `;
            } else {
                authContainer.innerHTML = `
                    <button onclick="openModal('authModal'); toggleAuthView(false);" class="text-xs bg-yellow-600 text-white px-3 py-1 rounded font-bold hover:bg-yellow-500 transition shadow-lg animate-pulse">
                        입문 (로그인)
                    </button>
                `;
            }
        }
        
        // ------------------------------------------------------------------
        // 4. 이미지/미디어 처리 (간소화된 Storage 업로드)
        // ------------------------------------------------------------------

        /**
         * 이미지 파일을 Storage에 직접 업로드 후 URL을 반환 (WebP 변환 로직 제거로 고속화)
         */
        async function uploadImage(file, folderPath) {
            const fileExtension = file.name.split('.').pop();
            const fileName = `${Date.now()}_${Math.random().toString(36).substring(2, 9)}.${fileExtension}`;
            const filePath = `${folderPath}/${fileName}`;
            
            const { data, error } = await client.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, file, { 
                    cacheControl: '3600',
                    upsert: false,
                });

            if (error) {
                console.error('Supabase Storage Upload Error:', error);
                throw error;
            } else {
                const publicUrl = client.storage.from(STORAGE_BUCKET).getPublicUrl(data.path).data.publicUrl;
                return publicUrl;
            }
        }
        
        window.handleImageUpload = async function() {
            if (!state.user) {
                showToast('이미지 업로드는 로그인 사용자만 가능합니다.', 'error');
                return;
            }
            
            const fileInput = document.getElementById('image-upload-input');
            const file = fileInput.files[0];
            if (!file) return;
            
            console.log('이미지 업로드 중...');
            try {
                // 고속화된 파일 업로드 사용
                const publicUrl = await uploadImage(file, 'posts');
                
                const editor = document.getElementById('new-post-content');
                const imgTag = `<img src="${publicUrl}" class="max-w-full h-auto rounded-lg shadow-md my-3" loading="lazy" onerror="this.src='https://placehold.co/400x200/333/fff?text=이미지+로드+실패'">`;
                
                editor.focus();
                document.execCommand('insertHTML', false, imgTag);
                
                showToast('이미지 삽입 완료.', 'success');
            } catch (error) {
                console.error('최종 이미지 업로드 실패:', error);
                showToast(`이미지 업로드 실패: ${error.message || 'Supabase RLS나 연결 상태를 확인해주세요.'}`, 'error');
            } finally {
                fileInput.value = '';
            }
        };

        window.openYouTubeModal = function() {
            document.getElementById('youtube-url-input').value = '';
            openModal('youtubeEmbedModal');
        }

        window.handleYouTubeEmbedFromModal = function() {
            const url = document.getElementById('youtube-url-input').value.trim();
            closeModal('youtubeEmbedModal');

            if (!url) return;

            let videoId;
            // YouTube URL 정규식 검사 및 Video ID 추출
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                videoId = match[2];
            } else {
                showToast('유효한 YouTube URL이 아닙니다.', 'error');
                return;
            }

            const embedHtml = `
                <div class="my-4 w-full" style="aspect-ratio: 16 / 9;">
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen 
                        class="rounded-lg shadow-xl w-full h-full"
                    ></iframe>
                </div>
            `;
            const editor = document.getElementById('new-post-content');
            document.execCommand('insertHTML', false, embedHtml);
            showToast('YouTube 동영상 삽입 완료.', 'success');
        };
        
        // ------------------------------------------------------------------
        // 5. 게시글 CRUD 로직 (암천객잔 비로그인 쓰기 허용)
        // ------------------------------------------------------------------
        
        async function savePost() {
            // 버튼 비활성화 (이중 클릭 방지)
            const saveBtn = document.getElementById('save-post-btn');
            saveBtn.disabled = true;
            saveBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const type = document.querySelector('input[name="post-type"]:checked').value;
                const title = document.getElementById('new-post-title').value;
                const contentHTML = document.getElementById('new-post-content').innerHTML.trim();

                if (!title || !contentHTML) {
                    showToast('제목과 내용을 모두 입력해야 합니다.', 'error');
                    return; // 함수 종료
                }

                const isGuest = !state.user;
                const isGuestSecretPost = isGuest && type === 'secret';
                
                // 비로그인 상태이면서 비밀 글이 아니면 막기
                if (isGuest && !isGuestSecretPost) {
                    showToast('로그인 후 이용 가능합니다. (암천객잔의 새로운 글만 비로그인 허용)', 'error');
                    return; // 함수 종료
                }

                let stockName = null;
                if (type === 'stock') {
                    if (isGuest) {
                        showToast('종목비급은 로그인 사용자만 작성 가능합니다.', 'error');
                        return; // 함수 종료
                    }
                    
                    stockName = document.getElementById('stock-input').value.trim();
                    if (!stockName) {
                        showToast('종목명을 입력해야 합니다.', 'error');
                        return; // 함수 종료
                    }

                    // 태그 생성/업데이트 로직 (효율을 위해 단순 유지)
                    if (!state.isEditing) {
                        const { data } = await client.from('stock_tags').select('name').eq('name', stockName);
                        if (data.length === 0) {
                            const { error } = await client.from('stock_tags').insert({ name: stockName });
                            if (error) console.error('태그 생성 실패:', error);
                            else await fetchStockTags();
                        }
                    }
                }

                const payload = {
                    title, content: contentHTML, type, 
                    stock_id: stockName,
                    mugong_id: type === 'public' ? document.getElementById('mu-gong-select').value : null,
                };

                let error;
                let successMessage;
                
                if (state.isEditing) {
                    // 수정은 반드시 로그인한 원작자만 가능
                    if (isGuest) {
                        showToast('비로그인 사용자는 글을 수정할 수 없습니다.', 'error');
                        return; // 함수 종료
                    }

                    const { error: updateError } = await client.from('posts')
                        .update(payload)
                        .eq('id', state.currentPostId)
                        .eq('user_id', state.user.id);
                    error = updateError;
                    successMessage = '비급이 수정되었습니다.';
                } else {
                    // 등록
                    if (isGuestSecretPost) {
                        // 암천객잔에 비로그인으로 등록
                        payload.user_id = null; // RLS가 허용하도록 user_id를 명시적으로 null로 설정
                        payload.guest_nickname = state.guestName;
                    } else {
                        // 로그인 사용자로 등록 (다른 타입 포함)
                        payload.user_id = state.user.id;
                    }
                    
                    const { error: insertError } = await client.from('posts').insert(payload);
                    error = insertError;
                    successMessage = '비급이 기록되었습니다.';
                }

                if (error) {
                    console.error(`비급 ${state.isEditing ? '수정' : '등록'} 실패:`, error);
                    showToast(`비급 ${state.isEditing ? '수정' : '등록'} 실패: ${error.message}`, 'error');
                } else {
                    showToast(successMessage, 'success');
                    closeModal('newPostModal');
                    
                    if (type === 'stock') {
                        state.currentStockName = stockName; 
                        navigate('stock-board');
                    } else if (type === 'secret') {
                        navigate('secret-inn');
                    } else {
                        // 현재 활성화된 뷰로 이동 (예: 강호광장에서 작성했으면 강호광장으로)
                        navigate(document.querySelector('.app-view:not(.hidden)').id);
                    }
                }
            } catch (e) {
                console.error('글 저장 중 예기치 않은 오류 발생:', e);
                showToast(`예상치 못한 오류 발생: ${e.message}`, 'error');
            } finally {
                // 버튼 재활성화
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        window.showDeleteConfirm = function() {
            if (!state.currentPostId || !state.postToEdit) return;
            document.getElementById('confirm-delete-title').innerText = state.postToEdit.title;
            openModal('deleteConfirmModal');
        }

        window.deletePost = async function(postId) {
            closeModal('deleteConfirmModal');
            
            if (!state.user || !state.postToEdit) {
                showToast('삭제 권한이 없습니다. (로그인 및 게시글 정보 필요)', 'error');
                return;
            }

            const post = state.postToEdit;
            const isAdministrator = isAdmin(); // 관리자 여부 확인
            const isAuthor = state.user.id === post.user_id;
            const isSecretPost = post.type === 'secret';

            // --- 암천객잔 삭제 권한 로직 (관리자만 허용) ---
            if (isSecretPost) {
                if (!isAdministrator) {
                    showToast('암천객잔의 글은 관리자만 삭제할 수 있습니다.', 'error');
                    return;
                }
            } 
            // --- 기타 게시판 삭제 권한 로직 (원작자 또는 관리자) ---
            else {
                 if (!isAdministrator && !isAuthor) {
                    showToast('해당 게시글의 원작자 또는 관리자만 삭제할 수 있습니다.', 'error');
                    return;
                }
            }

            // 안전 삭제 로직: 내용에서 Storage 파일 URL 추출 및 삭제
            const content = post.content;
            // .jpg, .png 등 이미지 확장자를 포함하여 더 넓은 범위의 URL을 추출하도록 수정
            const urlRegex = /src="([^"]*?(\.(jpg|jpeg|png|gif|webp|tiff|bmp)))"/gi;
            const baseUrl = `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/posts/`;

            const filesToDelete = [...content.matchAll(urlRegex)]
                .map(match => match[1])
                .filter(url => url.startsWith(baseUrl))
                .map(url => url.substring(baseUrl.length).split('?')[0]); // 쿼리 스트링 제거

            if (filesToDelete.length > 0) {
                // NOTE: Storage RLS 설정에 따라 인증된 사용자만 삭제 가능합니다.
                const { error: storageError } = await client.storage.from(STORAGE_BUCKET).remove(filesToDelete);
                if (storageError) {
                    console.error('Storage 파일 삭제 오류 (DB 삭제는 계속 진행):', storageError);
                    showToast('연결된 파일 삭제 오류가 발생했습니다. (DB 삭제 시도)', 'error');
                } else {
                    console.log(`Storage 파일 ${filesToDelete.length}개 삭제 완료.`);
                }
            }

            // DB 게시글 삭제
            const { error: deleteError } = await client.from('posts').delete().eq('id', postId);

            if (deleteError) {
                console.error('게시글 DB 삭제 오류 (RLS 가능성 높음):', deleteError);
                showToast(`게시글 삭제 실패: ${deleteError.message} (RLS 확인 필요)`, 'error');
            } else {
                showToast('게시글 및 관련 자료가 삭제되었습니다.', 'success');
                closeModal('postDetailModal');
                navigate(document.querySelector('.app-view:not(.hidden)').id);
            }
        };
        
        // ------------------------------------------------------------------
        // 6. 뷰 및 네비게이션
        // ------------------------------------------------------------------

        function navigate(viewId) {
            document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-yellow-400', 'border-yellow-400');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            const activeBtn = document.querySelector(`button[onclick="navigate('${viewId}')"]`);
            if (activeBtn) {
                activeBtn.classList.replace('text-gray-500', 'text-yellow-400');
                activeBtn.classList.replace('border-transparent', 'border-yellow-400');
            }

            // 뷰에 따른 데이터 로딩
            if (viewId === 'gangho-plaza') renderPosts('posts-list-public', 'public');
            if (viewId === 'stock-board') {
                if(state.stockTags.length === 0) fetchStockTags();
                else renderPosts('posts-list-stock', 'stock', state.currentStockName);
            }
            if (viewId === 'secret-inn') renderPosts('posts-list-secret', 'secret');
            if (viewId === 'chat-hall') loadChat();
        }

        async function fetchStockTags() {
            const { data } = await client.from('stock_tags').select('name').order('created_at', { ascending: true });
            if (data) {
                state.stockTags = data.map(t => t.name); // 배열로 단순화
                renderStockTabs();
                renderStockOptions();
            }
        }

        function renderStockTabs() {
            const stockTabs = document.getElementById('stock-tabs');
            stockTabs.innerHTML = '';
            
            let tagsToRender = [...state.stockTags];
            if (state.currentStockName && !state.stockTags.includes(state.currentStockName)) {
                tagsToRender = [state.currentStockName, ...state.stockTags];
            }

            tagsToRender.forEach(tag => {
                const btn = document.createElement('button');
                const isActive = state.currentStockName === tag;
                btn.className = `px-3 py-1 rounded-full text-xs whitespace-nowrap transition border ${
                    isActive 
                    ? 'bg-green-800 text-white border-green-600 font-bold shadow-md shadow-green-900/50' 
                    : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700 hover:text-gray-200'
                }`;
                btn.innerText = tag;
                btn.onclick = () => {
                    state.currentStockName = tag;
                    renderStockTabs(); // 탭 활성화 업데이트
                    renderPosts('posts-list-stock', 'stock', tag);
                    document.getElementById('current-stock-name').innerText = tag;
                };
                stockTabs.appendChild(btn);
            });
            stockTabs.scrollLeft = 0;
        }

        function renderStockOptions() { 
            const dataList = document.getElementById('stock-options');
            dataList.innerHTML = state.stockTags.map(tag => `<option value="${tag}">`).join('');
        }
        
        async function fetchPosts(type, stockName = null) {
            let query = client.from('posts')
                .select(`*, profiles:user_id (nickname, post_count, comment_count)`) 
                .eq('type', type)
                .order('created_at', { ascending: false });

            if (stockName) query = query.eq('stock_id', stockName);

            const { data } = await query;
            return data || [];
        }

        // 게시글 리스트 항목 생성 함수
        function createPostElement(post) {
            // post.guest_nickname이 우선 순위가 되어야 합니다.
            const author = post.profiles?.nickname || post.guest_nickname || '익명 문도';
            const level = post.profiles ? calculateLevel(post.profiles.post_count, post.profiles.comment_count) : { name: '입문자', color: 'text-gray-500' };
            const mugong = MU_GONG_TYPES.find(m => m.id === post.mugong_id);

            const postEl = document.createElement('div');
            postEl.className = 'bg-[#1f2937] p-4 rounded-xl shadow-lg border border-gray-700 hover:border-yellow-600 transition cursor-pointer';
            postEl.onclick = () => openPostDetail(post);

            postEl.innerHTML = `
                <h4 class="text-white font-semibold truncate text-base mb-2">${post.title}</h4>
                <div class="text-xs text-gray-400 flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <span class="${level.color} font-medium">${level.name}</span>
                        <span class="text-yellow-400">${author}</span>
                        ${mugong ? `<span class="px-2 py-0.5 rounded-full text-[10px] bg-gray-700 ${mugong.color}">${mugong.tag}</span>` : ''}
                    </div>
                    <span class="text-gray-500">${new Date(post.created_at).toLocaleDateString()}</span>
                </div>
            `;
            return postEl;
        }

        async function renderPosts(containerId, type, stockName = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="text-center text-gray-500 py-10">... 비급을 로딩 중 ...</div>';
            
            const posts = await fetchPosts(type, stockName);
            container.innerHTML = ''; // 기존 콘텐츠 삭제

            if (posts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10">아직 등록된 비급이 없습니다. 첫 기록을 남겨보세요.</div>';
                return;
            }

            const fragment = document.createDocumentFragment();
            posts.forEach(post => {
                fragment.appendChild(createPostElement(post));
            });
            container.appendChild(fragment); // DOM에 한 번만 추가하여 성능 개선
        }

        window.openPostDetail = async function(post) {
            state.currentPostId = post.id;
            state.postToEdit = post;
            const modal = document.getElementById('postDetailModal');
            document.getElementById('detail-title').innerText = post.title;
            
            // 보안을 위해 DOMPurify 사용을 권장하나, 여기서는 innerHTML을 사용합니다.
            document.getElementById('detail-content').innerHTML = post.content;
            
            // post.guest_nickname이 우선 순위가 되어야 합니다.
            const author = post.profiles?.nickname || post.guest_nickname || '익명 문도';
            document.getElementById('detail-author').innerText = author;
            
            const isAdministrator = isAdmin(); // 관리자 여부 확인
            const isAuthor = state.user?.id === post.user_id; 
            const isSecretPost = post.type === 'secret';
            
            let canDelete;
            if (isSecretPost) {
                // 암천객잔: 관리자만 삭제 가능
                canDelete = isAdministrator;
            } else {
                // 기타 게시판: 원작자 또는 관리자만 삭제 가능 (RLS에 따름)
                canDelete = isAuthor || isAdministrator;
            }

            // Edit 버튼은 여전히 원작자에게만 노출 (비로그인 글은 수정 불가)
            document.getElementById('edit-post-btn').classList.toggle('hidden', !isAuthor);
            
            // Delete 버튼은 계산된 canDelete 조건에 따라 노출
            document.getElementById('delete-post-btn').classList.toggle('hidden', !canDelete);
            
            // 버튼 이벤트 재연결
            document.getElementById('delete-post-btn').onclick = () => showDeleteConfirm(); 
            document.getElementById('edit-post-btn').onclick = () => openPostEditModal(post);
            
            loadComments(post.id);
            modal.classList.remove('hidden');
        }
        
        window.openPostEditModal = function(post) {
            // 비로그인 글은 수정 불가
            if (!state.user || state.user.id !== post.user_id) {
                showToast('수정 권한이 없습니다. 비로그인 글이거나 작성자가 아닙니다.', 'error');
                return;
            }
            closeModal('postDetailModal');
            
            state.isEditing = true;
            state.currentPostId = post.id;
            state.postToEdit = post;
            
            document.getElementById('post-modal-title').innerText = '비급 수정';
            document.getElementById('save-post-text').innerText = '수정 완료';

            // UI 업데이트 및 데이터 바인딩
            document.getElementById(`type-${post.type}`).checked = true;
            togglePostTypeFields(post.type);
            document.getElementById('new-post-title').value = post.title;
            document.getElementById('new-post-content').innerHTML = post.content;
            
            if (post.type === 'stock') {
                document.getElementById('stock-input').value = post.stock_id;
            }
            if (post.type === 'public') {
                document.getElementById('mu-gong-select').value = post.mugong_id;
            }

            openModal('newPostModal');
            document.getElementById('new-post-content').focus();
        }


        // ------------------------------------------------------------------
        // 7. 댓글 로직 (실시간 유지)
        // ------------------------------------------------------------------

        async function loadComments(postId) {
            const { data } = await client.from('comments')
                .select(`*, profiles:user_id (nickname, post_count, comment_count)`)
                .eq('post_id', postId)
                .order('created_at', { ascending: true });
            renderComments(data || []);
            setupRealtimeComments(postId);
        }

        function renderComments(comments) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            comments.forEach(comment => {
                const author = comment.profiles?.nickname || comment.guest_nickname || '익명';
                const level = comment.profiles ? calculateLevel(comment.profiles.post_count, comment.profiles.comment_count) : { name: '입문자', color: 'text-gray-500' };

                const commentEl = document.createElement('div');
                commentEl.className = 'p-2 rounded-lg bg-gray-700/50';
                commentEl.innerHTML = `
                    <p class="text-[10px] text-gray-400 mb-1">
                        <span class="${level.color}">${level.name}</span>
                        <span class="text-yellow-300 font-medium">${author}</span>
                        <span class="float-right">${new Date(comment.created_at).toLocaleTimeString()}</span>
                    </p>
                    <p class="text-xs text-gray-200">${comment.content}</p>
                `;
                fragment.appendChild(commentEl);
            });
            list.appendChild(fragment);
            list.scrollTop = list.scrollHeight;
        }

        async function addComment() {
            const postId = state.currentPostId;
            const input = document.getElementById('comment-input');
            const content = input.value.trim();
            if (!content || !postId) {
                showToast('댓글 내용을 입력해주세요.', 'error');
                return;
            }

            const payload = {
                post_id: postId,
                content: content,
                user_id: state.user?.id || null,
                guest_nickname: state.user ? null : state.guestName,
            };

            const { error } = await client.from('comments').insert(payload);
            if (error) {
                console.error('댓글 등록 실패:', error);
                showToast(`댓글 등록 실패: ${error.message}`, 'error');
            } else {
                input.value = '';
                showToast('댓글이 등록되었습니다.', 'success');
            }
        }

        function setupRealtimeComments(postId) {
            const channelKey = `comments_${postId}`;
            if (state.realtimeChannels[channelKey]) {
                client.removeChannel(state.realtimeChannels[channelKey]);
            }
            const channel = client.channel(channelKey)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'comments', filter: `post_id=eq.${postId}` }, 
                    () => loadComments(postId)
                ).subscribe();
            state.realtimeChannels[channelKey] = channel;
        }

        // ------------------------------------------------------------------
        // 8. 채팅 로직 (실시간 유지)
        // ------------------------------------------------------------------

        async function loadChat() {
            const { data } = await client.from('chat_messages')
                .select(`*, profiles:user_id (nickname)`)
                .order('created_at', { ascending: false })
                .limit(50);
            renderChat(data.reverse() || []);
            setupRealtimeChat();
        }

        function renderChat(messages) {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            messages.forEach(msg => {
                const author = msg.profiles?.nickname || msg.guest_nickname || '익명 문도';
                const msgEl = document.createElement('div');
                msgEl.className = 'text-xs mb-1';
                msgEl.innerHTML = `<span class="text-yellow-400 font-medium">${author}:</span> <span class="text-gray-300">${msg.content}</span>`;
                fragment.appendChild(msgEl);
            });
            chatList.appendChild(fragment);
            chatList.scrollTop = chatList.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content) return;

            const payload = {
                content: content,
                user_id: state.user?.id || null,
                guest_nickname: state.user ? null : state.guestName,
            };

            const { error } = await client.from('chat_messages').insert(payload);
            if (error) {
                console.error('채팅 전송 실패:', error);
                showToast(`채팅 전송 실패: ${error.message}`, 'error');
            } else {
                input.value = '';
            }
        }
        
        function setupRealtimeChat() {
             if (state.realtimeChannels['chat']) {
                client.removeChannel(state.realtimeChannels['chat']);
            }
            const channel = client.channel('chat')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, 
                    () => loadChat() // 단순화를 위해 전체 로드 재사용 (성능 최적화 시 INSERT 이벤트로직 필요)
                ).subscribe();
            state.realtimeChannels['chat'] = channel;
        }


        // ------------------------------------------------------------------
        // 9. 초기화 및 전역 함수 등록
        // ------------------------------------------------------------------
        
        /**
         * 게시글 작성 모달의 상태와 UI를 초기화합니다.
         */
        function resetPostStateAndUI() {
            state.isEditing = false;
            state.postToEdit = null;
            state.currentPostId = null; 

            document.getElementById('post-modal-title').innerText = '비급 작성';
            document.getElementById('save-post-text').innerText = '등록';
            document.getElementById('new-post-title').value = '';
            document.getElementById('new-post-content').innerHTML = '';
            
            document.querySelectorAll('input[name="post-type"]').forEach(radio => {
                radio.disabled = false;
                radio.checked = false; 
            });
            document.getElementById('type-public').checked = true;
            togglePostTypeFields('public');
        }

        function init() {
            // 무공 선택 옵션 로드
            const mugongSel = document.getElementById('mu-gong-select');
            MU_GONG_TYPES.forEach(m => mugongSel.innerHTML += `<option value="${m.id}">${m.name}</option>`);

            fetchStockTags();
            checkSession(); // 인증 확인 및 UI 업데이트
            navigate('gangho-plaza');
        }

        // 전역 함수 등록
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            if (id === 'newPostModal') {
                resetPostStateAndUI();
            }
        };
        // 나머지 함수들은 HTML 인라인 이벤트 핸들러를 위해 window에 등록 유지
        window.navigate = navigate;
        window.handleAuth = handleAuth;
        window.logout = logout;
        window.sendChat = sendChat;
        window.addComment = addComment;
        window.deletePost = deletePost;
        window.savePost = savePost;
        window.showDeleteConfirm = showDeleteConfirm; 
        
        window.formatDoc = function(cmd, value = null) {
            document.execCommand(cmd, false, value);
            document.getElementById('new-post-content').focus();
        };

        // 암천객잔(secret)은 비로그인 허용
        window.tryOpenWriteModal = function(type) {
            const isGuestPosting = type === 'secret' && !state.user;

            if (!state.user && !isGuestPosting) {
                showToast('비급 기록은 로그인 사용자만 가능합니다. (암천객잔의 새로운 글 제외)', 'error');
                openModal('authModal');
                // 로그인 뷰로 강제 전환
                toggleAuthView(false);
                return;
            }
            
            resetPostStateAndUI(); 

            document.getElementById(`type-${type}`).checked = true;
            togglePostTypeFields(type);
            openModal('newPostModal');
            
            // 비로그인 상태에서는 '암천객잔'만 선택 가능하도록 강제
            if (!state.user) {
                document.getElementById('type-public').disabled = true;
                document.getElementById('type-stock').disabled = true;
                document.getElementById('type-secret').checked = true;
                document.getElementById('type-secret').disabled = false;
                togglePostTypeFields('secret');
                showToast(`암천객잔은 모두에게 열려있습니다. 나그네 닉네임: ${state.guestName}`, 'success');
            } else {
                 document.getElementById('type-public').disabled = false;
                 document.getElementById('type-stock').disabled = false;
                 document.getElementById('type-secret').disabled = false;
            }

            if (type === 'stock') {
                document.getElementById('stock-input').value = state.currentStockName;
            }
             document.getElementById('new-post-content').focus();
        };

        window.togglePostTypeFields = (type) => {
            document.getElementById('mu-gong-area').classList.toggle('hidden', type !== 'public');
            document.getElementById('stock-area').classList.toggle('hidden', type !== 'stock');

            // 수정 모드에서는 타입 변경을 막기 위해 Radio 버튼을 비활성화 (로그인 상태에서만 작동)
            document.querySelectorAll('input[name="post-type"]').forEach(radio => {
                radio.disabled = state.isEditing || (!state.user && type !== 'secret');
            });
            // 암천객잔은 비로그인 상태에서도 작성 가능해야 하므로 재활성화
            if (!state.user) {
                 document.getElementById('type-secret').disabled = false;
            }
        };

        window.handleYouTubeEmbed = window.openYouTubeModal;
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <style>
        /* 기본 스타일 및 폰트 */
        body { background-color: #111118; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        /* 에디터 스타일 */
        #new-post-content { min-height: 150px; padding: 12px; border: 1px solid #374151; background-color: #1f2937; border-radius: 0 0 8px 8px; }
        #new-post-content:focus { outline: none; }
        #new-post-content[contenteditable]:empty:before {
            content: attr(placeholder);
            color: #6b7280;
            opacity: 0.6;
            pointer-events: none;
        }
        .editor-toolbar { background-color: #374151; }
        /* 반응형 이미지 및 iframe 스타일 */
        #detail-content img { max-width: 100%; height: auto; margin: 0.75rem 0; }
        #detail-content iframe { max-width: 100%; height: auto; }
        /* 종목 탭 스크롤바 숨기기 (모바일 친화적) */
        #stock-tabs { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-[#111118]/90 backdrop-blur-md border-b border-gray-800">
        <div class="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
            <h1 class="text-xl font-bold italic text-yellow-500 tracking-tighter cursor-pointer" onclick="navigate('gangho-plaza')">千金門</h1>
            <div id="auth-buttons"></div>
        </div>
        <nav class="flex justify-around border-b border-gray-800 bg-[#151520]">
            <button onclick="navigate('gangho-plaza')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 text-yellow-400 border-yellow-400 transition-colors">강호광장</button>
            <button onclick="navigate('stock-board')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">종목비급</button>
            <button onclick="navigate('chat-hall')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">무림채팅</button>
            <button onclick="navigate('secret-inn')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">암천객잔</button>
        </nav>
    </header>

    <main class="flex-grow max-w-md mx-auto w-full pb-20 p-4">

        <!-- 1. 강호광장 (Public Posts) -->
        <div id="gangho-plaza" class="app-view">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">강호 광장 (무공 토론)</h2>
            <div class="space-y-4" id="posts-list-public"></div>
        </div>

        <!-- 2. 종목비급 (Stock Posts) -->
        <div id="stock-board" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">종목 비급 (<span id="current-stock-name">삼성전자</span>)</h2>
            
            <!-- Stock Tabs -->
            <div id="stock-tabs" class="flex overflow-x-auto space-x-2 pb-3 scroll-hidden"></div>
            
            <div class="space-y-4 mt-4" id="posts-list-stock"></div>
        </div>

        <!-- 3. 무림 채팅 (Chat) -->
        <div id="chat-hall" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">무림 채팅 (실시간 잡담)</h2>
            <div id="chat-list" class="bg-[#1f2937] p-3 rounded-lg h-[60vh] overflow-y-auto scroll-hidden mb-4 border border-gray-700">
                <!-- Chat Messages will be rendered here -->
            </div>
            <div class="flex gap-2">
                <input id="chat-input" type="text" placeholder="채팅 입력..." onkeydown="if(event.key==='Enter') sendChat()" class="flex-grow bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white">
                <button onclick="sendChat()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-500">전송</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">* 비로그인 시 임시 닉네임으로 참여합니다.</p>
        </div>

        <!-- 4. 암천객잔 (Secret Posts) -->
        <div id="secret-inn" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">암천 객잔 (비밀 글 - 모두가 쓰고 모두가 봅니다)</h2>
            <div class="space-y-4" id="posts-list-secret"></div>
        </div>

        <!-- Floating Write Button -->
        <button onclick="tryOpenWriteModal(document.querySelector('.app-view:not(.hidden)').id === 'secret-inn' ? 'secret' : 'public')" 
                class="fixed bottom-20 right-6 w-12 h-12 bg-yellow-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl font-bold hover:bg-yellow-500 transition z-50">
            +
        </button>
    </main>
    
    <!-- Footer (Fixed to bottom, spanning full width) -->
    <footer class="fixed bottom-0 z-30 w-full bg-[#111118]/90 backdrop-blur-md border-t border-gray-800">
        <div class="max-w-md mx-auto px-4 py-2 flex justify-between items-center text-[10px] sm:text-xs text-gray-500">
            <!-- Copyright -->
            <p>&copy; 2024 千金門. All rights reserved.</p>
            <!-- Links to Modals -->
            <div class="space-x-3">
                <span class="hover:text-white cursor-pointer" onclick="openModal('termsModal')">이용 약관</span>
                <span class="hover:text-white cursor-pointer" onclick="openModal('privacyModal')">개인정보 방침</span>
            </div>
        </div>
    </footer>
    
    <!-- Toast Notification (추가됨) -->
    <div id="toast-notification" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 p-3 rounded-xl shadow-2xl z-[100] transition duration-300 bg-green-600 text-white font-medium text-sm">
        <span id="toast-message"></span>
    </div>

    <!-- ------------------------------------------------------------------ -->
    <!-- Modals -->
    <!-- ------------------------------------------------------------------ -->

    <!-- Write/Edit Modal (WYSIWYG 에디터 적용) -->
    <div id="newPostModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-md p-5 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4"><span id="post-modal-title">비급 작성</span></h3>
            
            <div class="flex space-x-3 mb-4 text-sm text-gray-300">
                <label class="flex items-center"><input type="radio" name="post-type" id="type-public" value="public" onchange="togglePostTypeFields('public')" class="mr-1" checked>강호광장</label>
                <label class="flex items-center"><input type="radio" name="post-type" id="type-stock" value="stock" onchange="togglePostTypeFields('stock')" class="mr-1">종목비급</label>
                <label class="flex items-center"><input type="radio" name="post-type" id="type-secret" value="secret" onchange="togglePostTypeFields('secret')" class="mr-1">암천객잔</label>
            </div>

            <div id="stock-area" class="mb-3 hidden">
                <label class="text-xs text-gray-400 mb-1 block">종목명</label>
                <input type="text" id="stock-input" list="stock-options" class="w-full bg-gray-800 border border-gray-700 text-white p-2 rounded text-sm placeholder-gray-500" placeholder="예: 엔비디아, 비트코인...">
                <datalist id="stock-options"></datalist>
                <p class="text-[10px] text-green-500 mt-1">* 목록에 없는 종목을 입력하면 새로운 문파(탭)가 창설됩니다.</p>
            </div>

            <div id="mu-gong-area" class="mb-3">
                <label class="text-xs text-gray-400 mb-1 block">사용 무공</label>
                <select id="mu-gong-select" class="w-full bg-gray-800 border border-gray-700 text-white p-2 rounded text-sm"></select>
            </div>

            <input id="new-post-title" type="text" placeholder="제목" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-t-lg mb-0 text-sm">
            
            <!-- Rich Text Editor Toolbar -->
            <div class="editor-toolbar flex flex-wrap gap-2 p-2 rounded-b-none border-b border-gray-700">
                <button onclick="formatDoc('bold')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500 font-bold">B</button>
                <button onclick="formatDoc('italic')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500 italic">I</button>
                <button onclick="formatDoc('underline')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500 underline">U</button>
                <button onclick="formatDoc('insertUnorderedList')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500">UL</button>
                
                <!-- 이미지 업로드 버튼 (WebP 변환 제거됨) -->
                <label for="image-upload-input" class="text-white px-2 py-1 text-xs rounded bg-green-700 hover:bg-green-600 cursor-pointer flex items-center">
                    🖼️ 이미지
                </label>
                <input type="file" id="image-upload-input" accept="image/*" class="hidden" onchange="handleImageUpload()">
                
                <!-- YouTube 임베드 버튼 -->
                <button onclick="openYouTubeModal()" class="text-white px-2 py-1 text-xs rounded bg-red-700 hover:bg-red-600 flex items-center">
                    ▶️ YouTube
                </button>
            </div>

            <!-- Content Editable Area (placeholder 속성 적용) -->
            <div id="new-post-content" contenteditable="true" placeholder="내용을 입력하세요..." 
                class="w-full text-sm text-gray-200 overflow-y-auto">
            </div>

            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('newPostModal')" class="px-4 py-2 text-sm bg-gray-700 rounded-lg text-gray-300">취소</button>
                <button id="save-post-btn" onclick="savePost()" class="px-4 py-2 text-sm bg-blue-600 rounded-lg text-white font-bold hover:bg-blue-500 transition"><span id="save-post-text">등록</span></button>
            </div>
        </div>
    </div>
    
    <!-- Post Detail Modal -->
    <div id="postDetailModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-md h-[80vh] flex flex-col p-0 rounded-2xl border border-gray-600 shadow-2xl overflow-hidden">
            <div class="p-5 border-b border-gray-800 flex-shrink-0">
                <h3 id="detail-title" class="text-lg font-bold text-white mb-2"></h3>
                <div class="flex justify-between items-center text-xs text-gray-500">
                    <div id="detail-author"></div>
                    <div class="flex space-x-3 items-center">
                         <button id="edit-post-btn" class="hidden text-cyan-400 hover:text-cyan-300 font-bold text-xs">수정</button>
                         <button id="delete-post-btn" class="hidden text-red-500 hover:text-red-400 font-bold text-xs">삭제</button>
                         <button onclick="closeModal('postDetailModal')" class="text-gray-400 hover:text-white">✕</button>
                    </div>
                </div>
            </div>
            <!-- HTML 내용이 렌더링될 곳 -->
            <div class="flex-grow overflow-y-auto p-5 scroll-hidden">
                <div id="detail-content" class="text-sm text-gray-300 post-content-style"></div>
            </div>
            <div class="p-3 bg-[#151520] border-t border-gray-800 flex-shrink-0">
                <div id="comments-list" class="max-h-32 overflow-y-auto mb-3 space-y-2 scroll-hidden"></div>
                <div class="flex gap-2">
                    <input id="comment-input" type="text" placeholder="댓글 입력..." onkeydown="if(event.key==='Enter') addComment()" class="flex-grow bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xs text-white">
                    <button onclick="addComment()" class="bg-gray-700 text-white px-3 py-2 text-xs rounded-lg font-bold hover:bg-gray-600">전송</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal (인증 모달 - 비밀번호 확인 및 약관 동의 추가) -->
    <div id="authModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-sm p-6 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-5 text-center">문파 입문 (Authentication)</h3>
            
            <input id="auth-email" type="email" placeholder="이메일" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mb-3 text-sm">
            <input id="auth-password" type="password" placeholder="비밀번호" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mb-3 text-sm">
            
            <!-- 회원가입 전용 필드 -->
            <div id="signup-fields" class="space-y-3 hidden">
                <input id="auth-confirm-password" type="password" placeholder="비밀번호 확인" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg text-sm">
                <div class="flex items-start text-xs text-gray-400">
                    <input type="checkbox" id="auth-terms" class="mt-1 mr-2 accent-yellow-600">
                    <label for="auth-terms">
                        <span class="text-red-400 font-bold">*필수: </span> 
                        <span class="cursor-pointer hover:text-white" onclick="openModal('termsModal')">이용 약관</span> 및 
                        <span class="cursor-pointer hover:text-white" onclick="openModal('privacyModal')">개인정보 처리 방침</span>에 동의합니다.
                    </label>
                </div>
            </div>
            
            <div class="flex gap-3 mt-5">
                <button id="login-btn" onclick="toggleAuthView(false); handleAuth(false);" class="flex-1 px-4 py-3 text-sm bg-yellow-600 rounded-lg text-white font-bold hover:bg-yellow-500 transition">로그인</button>
                <button id="signup-btn" onclick="toggleAuthView(true); handleAuth(true);" class="flex-1 px-4 py-3 text-sm bg-gray-700 rounded-lg text-gray-300 hover:bg-gray-600 transition">회원가입</button>
            </div>
            
            <div class="flex justify-center gap-3 mt-3">
                 <button onclick="toggleAuthView(false);" class="text-xs text-yellow-500 hover:text-yellow-400">로그인 전환</button>
                 <button onclick="toggleAuthView(true);" class="text-xs text-green-500 hover:text-green-400">회원가입 전환</button>
            </div>

            <p onclick="closeModal('authModal')" class="text-xs text-gray-500 mt-5 text-center cursor-pointer hover:text-gray-300">잠시 둘러보기 (창 닫기)</p>
        </div>
    </div>

    <!-- Terms Modal (이용 약관 모달) -->
    <div id="termsModal" class="hidden fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-md h-[90vh] flex flex-col p-6 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">이용 약관</h3>
            <div class="flex-grow overflow-y-auto p-3 bg-gray-800 rounded-lg text-sm text-gray-300 space-y-3">
                <p class="font-bold text-yellow-400">제 1조 (목적)</p>
                <p>본 약관은 천금문(千金門) 앱(이하 '서비스')의 이용 조건 및 절차에 관한 사항과 기타 필요한 사항을 규정함을 목적으로 합니다.</p>
                
                <p class="font-bold text-yellow-400">제 2조 (정의)</p>
                <p>① 이용자: 본 약관에 따라 서비스를 이용하는 회원 및 비회원.</p>
                <p>② 회원: 서비스에 회원가입을 한 자로서, 지속적인 정보 제공 및 이용이 가능한 자.</p>
                <p>③ 비급 (게시글): 이용자가 서비스에 게시한 모든 정보 (글, 사진, 동영상 등).</p>
                
                <p class="font-bold text-yellow-400">제 3조 (회원가입)</p>
                <p>① 이용자는 본 약관에 동의함으로써 회원가입을 신청합니다.</p>
                <p>② 회원은 서비스 이용 시 정확한 정보를 기재해야 하며, 허위 정보 기재로 인한 불이익은 본인에게 있습니다.</p>
                
                <p class="font-bold text-yellow-400">제 4조 (서비스 이용 및 제한)</p>
                <p>① 서비스는 24시간 연중무휴를 원칙으로 합니다.</p>
                <p>② 다음의 경우 서비스 이용이 제한될 수 있습니다: 불법 복제, 음란물, 허위 사실 유포, 타인 비방, 스팸성 게시물.</p>
                
                <p class="font-bold text-yellow-400">제 5조 (게시물의 저작권 및 관리)</p>
                <p>① 회원이 게시한 비급의 저작권은 해당 작성자에게 귀속됩니다.</p>
                <p>② 서비스는 회원의 비급을 홍보, 전시 등의 목적으로 활용할 수 있습니다.</p>
                <p>③ 회원의 비급이 법령이나 약관에 위배되는 경우, 서비스는 사전 통보 없이 해당 비급을 삭제하거나 이동시킬 수 있습니다.</p>
            </div>
            <button onclick="closeModal('termsModal')" class="mt-4 px-4 py-2 text-sm bg-yellow-600 rounded-lg text-white font-bold hover:bg-yellow-500 flex-shrink-0">닫기</button>
        </div>
    </div>
    
    <!-- Privacy Modal (개인정보 처리 방침 모달) -->
    <div id="privacyModal" class="hidden fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-md h-[90vh] flex flex-col p-6 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">개인정보 처리 방침</h3>
            <div class="flex-grow overflow-y-auto p-3 bg-gray-800 rounded-lg text-sm text-gray-300 space-y-3">
                <p class="font-bold text-yellow-400">1. 개인정보 수집 및 이용 목적</p>
                <p>서비스는 회원가입, 서비스 이용, 불만 처리 등을 위해 개인정보를 수집 및 이용합니다.</p>
                
                <p class="font-bold text-yellow-400">2. 수집하는 개인정보 항목</p>
                <p>필수: 이메일 주소, 비밀번호(암호화 저장).</p>
                <p>선택: 닉네임, 기타 서비스 내 활동 기록 (게시글 수, 댓글 수 등).</p>
                
                <p class="font-bold text-yellow-400">3. 개인정보의 보유 및 이용 기간</p>
                <p>이용자의 개인정보는 원칙적으로 회원 탈퇴 시 지체 없이 파기합니다. 다만, 관계 법령에 따라 보존할 필요가 있는 경우 해당 법령이 정한 기간 동안 보존합니다.</p>
                
                <p class="font-bold text-yellow-400">4. 개인정보의 제3자 제공</p>
                <p>이용자의 개인정보를 원칙적으로 외부에 제공하지 않습니다. 다만, 이용자가 사전에 동의했거나, 법령에 의거한 경우에는 예외로 합니다.</p>
                
                <p class="font-bold text-yellow-400">5. 개인정보 보호 책임자</p>
                <p>본 서비스는 개인 프로젝트이므로 별도의 책임자는 지정되어 있지 않으나, 개인정보 보호를 위해 Supabase RLS 및 보안 설정을 충실히 이행합니다. 문의사항은 [관리자 이메일]로 연락주시기 바랍니다.</p>
            </div>
            <button onclick="closeModal('privacyModal')" class="mt-4 px-4 py-2 text-sm bg-yellow-600 rounded-lg text-white font-bold hover:bg-yellow-500 flex-shrink-0">닫기</button>
        </div>
    </div>

    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-xs p-6 rounded-2xl border border-red-600 shadow-2xl text-center">
            <h3 class="text-lg font-bold text-red-400 mb-2">🚨 경고: 비급 영구 삭제</h3>
            <p class="text-sm text-gray-300 mb-3">정말로 아래 비급을 삭제하시겠습니까?</p>
            <p id="confirm-delete-title" class="text-base font-semibold text-yellow-400 truncate mb-5"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('deleteConfirmModal')" class="px-4 py-2 text-sm bg-gray-700 rounded-lg text-gray-300">취소</button>
                <button onclick="deletePost(state.currentPostId)" class="px-4 py-2 text-sm bg-red-600 rounded-lg text-white font-bold hover:bg-red-500">삭제 확인</button>
            </div>
        </div>
    </div>

    <!-- YouTube Embed Input Modal -->
    <div id="youtubeEmbedModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-sm p-6 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">▶️ YouTube 동영상 임베드</h3>
            <input id="youtube-url-input" type="url" placeholder="YouTube URL (예: https://youtu.be/xxx)" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mb-5 text-sm">
            <div class="flex gap-3 justify-end">
                <button onclick="closeModal('youtubeEmbedModal')" class="px-4 py-2 text-sm bg-gray-700 rounded-lg text-gray-300">취소</button>
                <button onclick="handleYouTubeEmbedFromModal()" class="px-4 py-2 text-sm bg-red-600 rounded-lg text-white font-bold hover:bg-red-500">임베드</button>
            </div>
        </div>
    </div>
</body>
</html>

