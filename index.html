<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>천금문 (千金門) - 즉시 갱신 패치</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ------------------------------------------------------------------
        // 1. Supabase 설정 (본인의 URL과 키로 교체 필요)
        // ------------------------------------------------------------------
        const SUPABASE_URL = 'https://cpssatqtodlplwgskfin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwc3NhdHF0b2RscGx3Z3NrZmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1Njg5MzUsImV4cCI6MjA4MTE0NDkzNX0.C5_6TRHvyEBbPcO3_FOh_WyMnAkhswOiBqxDUeKrV0I';
        
        // Supabase Client 생성
        let client;
        try {
            client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            alert("Supabase 클라이언트 초기화 실패. URL과 키를 확인하세요.");
        }

        const STORAGE_BUCKET = 'images';

        // ------------------------------------------------------------------
        // 2. 전역 상태
        // ------------------------------------------------------------------
        let isAuthenticating = false;
        let isSignUpMode = false;

        const state = {
            user: null,
            profile: null,
            currentPostId: null,
            postToEdit: null,
            isEditing: false,
            currentStockName: '삼성전자', 
            stockTags: [], 
            realtimeChannels: {},
            guestName: `나그네_${Math.floor(Math.random() * 1000)}`,
        };
        
        const ADMIN_EMAIL = 'salad20c@gmail.com'; 
        const LEVEL_NAMES = ['입문자', '초학자', '시세견습', '기문초해', '자본내공가', '강호시세객', '전략비급사', '시장현경', '초절정투객', '절세투자고수', '금룡장문'];
        const MU_GONG_TYPES = [
            { id: 'sword', name: '질풍검법 (단기)', tag: '단기', color: 'text-red-500' },
            { id: 'dao', name: '태극도법 (장기)', tag: '장기', color: 'text-blue-500' },
            { id: 'auto', name: '오토진법 (자동)', tag: '자동', color: 'text-yellow-500' },
        ];
        
        // ------------------------------------------------------------------
        // 3. 유틸리티 및 인증
        // ------------------------------------------------------------------
        
        function isAdmin() {
            return state.user && state.user.email === ADMIN_EMAIL;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const messageElement = document.getElementById('toast-message');
            
            toast.classList.remove('hidden', 'bg-red-600', 'bg-green-600');
            toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
            
            messageElement.innerText = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function calculateLevel(postCount, commentCount) {
            const score = (postCount || 0) + (commentCount || 0);
            const idx = Math.min(Math.floor(score / 10), LEVEL_NAMES.length - 1);
            return { name: LEVEL_NAMES[idx], color: idx > 5 ? 'text-yellow-400' : 'text-cyan-400' };
        }

        async function handleAuth() {
            if (isAuthenticating) return;
            isAuthenticating = true;
            
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !password) {
                alert('이메일과 비밀번호를 입력해주세요.');
                isAuthenticating = false;
                return;
            }
            
            let error;
            try {
                if (isSignUpMode) {
                    const confirmPassword = document.getElementById('auth-confirm-password').value;
                    const termsChecked = document.getElementById('auth-terms').checked;
                    
                    if (password !== confirmPassword) {
                        alert('비밀번호가 일치하지 않습니다.');
                        isAuthenticating = false;
                        return;
                    }
                    if (!termsChecked) {
                        alert('약관에 동의해야 합니다.');
                        isAuthenticating = false;
                        return;
                    }
                    ({ error } = await client.auth.signUp({ email, password }));
                } else {
                    ({ error } = await client.auth.signInWithPassword({ email, password }));
                }
            } catch (e) {
                error = e;
            }

            if (error) {
                alert(`인증 실패: ${error.message}`);
            } else {
                showToast(isSignUpMode ? '가입 성공! 이메일을 확인하세요.' : '로그인 성공!', 'success');
                closeModal('authModal');
                checkSession();
            }
            isAuthenticating = false;
        }
        
        async function logout() {
            await client.auth.signOut();
            state.profile = null;
            state.user = null;
            updateHeaderUI();
            navigate('gangho-plaza');
            showToast('하산했습니다.', 'success');
        }

        async function checkSession() {
            const { data: { session } } = await client.auth.getSession();
            updateAuthState(session);
            client.auth.onAuthStateChange((_event, session) => updateAuthState(session));
        }

        async function updateAuthState(session) {
            state.user = session ? session.user : null;
            if (state.user) {
                let { data, error } = await client.from('profiles').select('*').eq('id', state.user.id).single();
                if (!data && !error) { 
                   const { data: newProfile, error: createError } = await client.from('profiles').insert([{ id: state.user.id, nickname: '신입 문도' }]).select().single();
                   if(newProfile) data = newProfile;
                }
                state.profile = data || { nickname: '알 수 없음', post_count: 0, comment_count: 0 };
            } else {
                state.profile = null;
            }
            updateHeaderUI();
        }

        window.setAuthMode = function(mode) {
            isSignUpMode = (mode === 'signup');
            const loginTab = document.getElementById('tab-login');
            const signupTab = document.getElementById('tab-signup');
            const signUpFields = document.getElementById('signup-fields');
            const actionBtn = document.getElementById('auth-action-btn');
            
            if (isSignUpMode) {
                loginTab.classList.replace('border-yellow-500', 'border-transparent');
                loginTab.classList.replace('text-white', 'text-gray-500');
                signupTab.classList.replace('border-transparent', 'border-green-500');
                signupTab.classList.replace('text-gray-500', 'text-white');
                signUpFields.classList.remove('hidden');
                actionBtn.innerText = '문파 등록 (회원가입)';
                actionBtn.classList.replace('bg-yellow-600', 'bg-green-700');
                actionBtn.classList.replace('hover:bg-yellow-500', 'hover:bg-green-600');
            } else {
                signupTab.classList.replace('border-green-500', 'border-transparent');
                signupTab.classList.replace('text-white', 'text-gray-500');
                loginTab.classList.replace('border-transparent', 'border-yellow-500');
                loginTab.classList.replace('text-gray-500', 'text-white');
                signUpFields.classList.add('hidden');
                actionBtn.innerText = '입문 (로그인)';
                actionBtn.classList.replace('bg-green-700', 'bg-yellow-600');
                actionBtn.classList.replace('hover:bg-green-600', 'hover:bg-yellow-500');
            }
        }
        
        function updateHeaderUI() {
            const authContainer = document.getElementById('auth-buttons');
            if (state.user) {
                const nickname = state.profile?.nickname || '문도';
                const level = state.profile ? calculateLevel(state.profile.post_count, state.profile.comment_count) : { name: '입문자', color: 'text-gray-400' };
                authContainer.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-400 hidden sm:inline">레벨: <span class="${level.color} font-bold">${level.name}</span></span>
                        <span class="text-xs text-gray-400 hidden sm:inline"><span class="text-yellow-400 font-bold">${nickname}</span>님</span>
                        <button onclick="logout()" class="text-xs bg-red-900/50 text-red-200 px-3 py-1 rounded hover:bg-red-900 transition">하산</button>
                    </div>
                `;
            } else {
                authContainer.innerHTML = `
                    <button onclick="openModal('authModal'); setAuthMode('login');" class="text-xs bg-yellow-600 text-white px-3 py-1 rounded font-bold hover:bg-yellow-500 transition shadow-lg animate-pulse">
                        입문 (로그인)
                    </button>
                `;
            }
        }
        
        // ------------------------------------------------------------------
        // 4. 게시글 저장 로직
        // ------------------------------------------------------------------
        
        async function savePost() {
            const saveBtn = document.getElementById('save-post-btn');
            saveBtn.disabled = true;
            saveBtn.innerText = '저장 중...';

            try {
                const checkedRadio = document.querySelector('input[name="post-type"]:checked');
                if (!checkedRadio) throw new Error("게시판 종류가 선택되지 않았습니다.");
                const type = checkedRadio.value;
                const title = document.getElementById('new-post-title').value;
                const contentHTML = document.getElementById('new-post-content').innerHTML.replace(/<div id="img-loading-.*?<\/div>/g, '').trim();

                if (!title || !contentHTML) {
                    alert('제목과 내용을 모두 입력해야 합니다.');
                    return;
                }

                const isGuest = !state.user;
                const isGuestSecretPost = isGuest && type === 'secret';
                
                if (isGuest && !isGuestSecretPost) {
                    alert('비로그인 사용자는 [암천객잔]에만 글을 쓸 수 있습니다.');
                    return;
                }

                let stockName = null;
                if (type === 'stock') {
                    stockName = document.getElementById('stock-input').value.trim();
                    if (!stockName) {
                        alert('종목명을 입력해야 합니다.');
                        return;
                    }
                    const { data: existingTags } = await client.from('stock_tags').select('name').eq('name', stockName);
                    if (!existingTags || existingTags.length === 0) {
                        const { error: tagError } = await client.from('stock_tags').insert({ name: stockName });
                        if (tagError) console.warn('태그 생성 실패:', tagError.message);
                        else await fetchStockTags();
                    }
                }

                const payload = {
                    title, content: contentHTML, type, stock_id: stockName,
                    mugong_id: type === 'public' ? document.getElementById('mu-gong-select').value : null,
                };

                let error;
                let successMessage;
                
                if (state.isEditing) {
                    if (!state.user) throw new Error("수정 권한이 없습니다.");
                    const { error: updateError } = await client.from('posts').update(payload).eq('id', state.currentPostId).eq('user_id', state.user.id);
                    error = updateError;
                    successMessage = '비급이 수정되었습니다.';
                } else {
                    if (isGuestSecretPost) {
                        payload.user_id = null;
                        payload.guest_nickname = state.guestName;
                    } else {
                        payload.user_id = state.user.id;
                    }
                    const { error: insertError } = await client.from('posts').insert(payload);
                    error = insertError;
                    successMessage = '비급이 기록되었습니다.';
                }

                if (error) {
                    console.error('Save Error:', error);
                    let msg = error.message;
                    if (msg.includes('row-level security')) msg = "권한이 없습니다. (RLS 정책 위반)";
                    alert(`글 저장 실패:\n${msg}`);
                } else {
                    showToast(successMessage, 'success');
                    closeModal('newPostModal');
                    if (type === 'stock') {
                        state.currentStockName = stockName; 
                        navigate('stock-board');
                    } else if (type === 'secret') {
                        navigate('secret-inn');
                    } else {
                        navigate(document.querySelector('.app-view:not(.hidden)').id);
                    }
                }
            } catch (e) {
                console.error('Exception:', e);
                alert(`오류 발생: ${e.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = state.isEditing ? '수정 완료' : '등록';
            }
        }

        async function handleImageUpload() {
            if (!state.user) {
                alert('이미지 업로드는 로그인 사용자만 가능합니다.');
                return;
            }
            
            const fileInput = document.getElementById('image-upload-input');
            const file = fileInput.files[0];
            if (!file) return;

            const editor = document.getElementById('new-post-content');
            const loadingId = 'img-loading-' + Date.now();
            editor.focus();
            document.execCommand('insertHTML', false, `<div id="${loadingId}" class="text-yellow-400">이미지 업로드 중...</div>`);
            
            try {
                const fileExtension = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExtension}`;
                const filePath = `posts/${fileName}`;

                const { error: uploadError } = await client.storage.from(STORAGE_BUCKET).upload(filePath, file);
                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = client.storage.from(STORAGE_BUCKET).getPublicUrl(filePath);

                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                const imgHtml = `<img src="${publicUrl}" class="max-w-full rounded-lg my-2" /><br>`;
                document.execCommand('insertHTML', false, imgHtml);

            } catch (error) {
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
                alert(`이미지 업로드 실패: ${error.message}`);
            } finally {
                fileInput.value = '';
            }
        };
        
        // ------------------------------------------------------------------
        // 6. 데이터 조회 및 실시간 처리 (핵심 수정)
        // ------------------------------------------------------------------

        async function fetchPosts(type, stockName = null) {
            let query = client.from('posts').select(`*, profiles:user_id (nickname, post_count, comment_count)`).eq('type', type).order('created_at', { ascending: false });
            if (stockName) query = query.eq('stock_id', stockName);
            const { data, error } = await query;
            return data || [];
        }
        
        async function fetchStockTags() {
            const { data } = await client.from('stock_tags').select('name').order('created_at', { ascending: true });
            if (data) {
                state.stockTags = data.map(t => t.name);
                renderStockTabs();
                renderStockOptions();
            }
        }

        // ------------------------------------------------------------------
        // UI 렌더링
        // ------------------------------------------------------------------
        function renderStockTabs() {
            const stockTabs = document.getElementById('stock-tabs');
            stockTabs.innerHTML = '';
            let tagsToRender = [...state.stockTags];
            if (state.currentStockName && !state.stockTags.includes(state.currentStockName)) {
                tagsToRender = [state.currentStockName, ...state.stockTags];
            }
            tagsToRender.forEach(tag => {
                const btn = document.createElement('button');
                const isActive = state.currentStockName === tag;
                btn.className = `px-3 py-1 rounded-full text-xs whitespace-nowrap transition border ${isActive ? 'bg-green-800 text-white border-green-600 font-bold' : 'bg-gray-800 text-gray-400 border-gray-700'}`;
                btn.innerText = tag;
                btn.onclick = () => {
                    state.currentStockName = tag;
                    renderStockTabs();
                    renderPosts('posts-list-stock', 'stock', tag);
                    document.getElementById('current-stock-name').innerText = tag;
                };
                stockTabs.appendChild(btn);
            });
        }
        function renderStockOptions() { 
            document.getElementById('stock-options').innerHTML = state.stockTags.map(tag => `<option value="${tag}">`).join('');
        }
        function createPostElement(post) {
            const author = post.profiles?.nickname || post.guest_nickname || '익명 문도';
            const level = post.profiles ? calculateLevel(post.profiles.post_count, post.profiles.comment_count) : { name: '입문자', color: 'text-gray-500' };
            const mugong = MU_GONG_TYPES.find(m => m.id === post.mugong_id);
            const postEl = document.createElement('div');
            postEl.className = 'bg-[#1f2937] p-4 rounded-xl shadow-lg border border-gray-700 hover:border-yellow-600 transition cursor-pointer';
            postEl.onclick = () => openPostDetail(post);
            postEl.innerHTML = `
                <h4 class="text-white font-semibold truncate text-base mb-2">${post.title}</h4>
                <div class="text-xs text-gray-400 flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <span class="${level.color} font-medium">${level.name}</span>
                        <span class="text-yellow-400">${author}</span>
                        ${mugong ? `<span class="px-2 py-0.5 rounded-full text-[10px] bg-gray-700 ${mugong.color}">${mugong.tag}</span>` : ''}
                    </div>
                    <span class="text-gray-500">${new Date(post.created_at).toLocaleDateString()}</span>
                </div>`;
            return postEl;
        }
        async function renderPosts(containerId, type, stockName = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="text-center text-gray-500 py-10">... 비급을 로딩 중 ...</div>';
            const posts = await fetchPosts(type, stockName);
            container.innerHTML = ''; 
            if (posts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10">아직 등록된 비급이 없습니다. 첫 기록을 남겨보세요.</div>';
                return;
            }
            posts.forEach(post => container.appendChild(createPostElement(post)));
        }

        // ------------------------------------------------------------------
        // 상세, 댓글, 채팅 로직 (수정됨)
        // ------------------------------------------------------------------
        
        window.openPostDetail = async function(post) {
            state.currentPostId = post.id;
            state.postToEdit = post;
            const modal = document.getElementById('postDetailModal');
            document.getElementById('detail-title').innerText = post.title;
            document.getElementById('detail-content').innerHTML = post.content;
            document.getElementById('detail-author').innerText = post.profiles?.nickname || post.guest_nickname || '익명';
            
            const isAuthor = state.user?.id === post.user_id; 
            const isSecretPost = post.type === 'secret';
            const canDelete = isAuthor || isAdmin();

            document.getElementById('edit-post-btn').classList.toggle('hidden', !isAuthor);
            document.getElementById('delete-post-btn').classList.toggle('hidden', !canDelete);
            
            const delBtn = document.getElementById('delete-post-btn');
            const editBtn = document.getElementById('edit-post-btn');
            delBtn.onclick = () => { if(confirm("정말 삭제하시겠습니까?")) deletePost(post.id); };
            editBtn.onclick = () => openPostEditModal(post);
            
            modal.classList.remove('hidden');

            // 댓글 로드 및 실시간 구독 시작
            loadComments(post.id);
            setupRealtime('comments', `post_id=eq.${post.id}`, () => loadComments(post.id));
        }

        window.deletePost = async function(postId) {
            const { error } = await client.from('posts').delete().eq('id', postId);
            if (error) alert("삭제 실패: " + error.message);
            else {
                showToast("삭제되었습니다.");
                closeModal('postDetailModal');
                navigate(document.querySelector('.app-view:not(.hidden)').id);
            }
        }
        
        async function loadComments(postId) {
            const { data } = await client.from('comments').select(`*, profiles:user_id (nickname)`).eq('post_id', postId).order('created_at');
            const list = document.getElementById('comments-list');
            list.innerHTML = '';
            (data||[]).forEach(c => {
                const author = c.profiles?.nickname || c.guest_nickname || '익명';
                list.innerHTML += `<div class="bg-gray-700/50 p-2 rounded mb-1"><span class="text-yellow-300 text-xs">${author}</span> <span class="text-gray-200 text-xs">${c.content}</span></div>`;
            });
            list.scrollTop = list.scrollHeight;
        }

        async function addComment() {
            const content = document.getElementById('comment-input').value;
            if(!content) return;
            const { error } = await client.from('comments').insert({
                post_id: state.currentPostId,
                content,
                user_id: state.user?.id || null,
                guest_nickname: state.user ? null : state.guestName
            });
            if(error) alert("댓글 실패: " + error.message);
            else {
                document.getElementById('comment-input').value = '';
                // [중요] 즉시 갱신
                loadComments(state.currentPostId);
            }
        }

        async function loadChat() {
            const { data } = await client.from('chat_messages').select(`*, profiles:user_id (nickname)`).order('created_at', {ascending:false}).limit(50);
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            (data||[]).reverse().forEach(m => {
                const author = m.profiles?.nickname || m.guest_nickname || '익명';
                list.innerHTML += `<div class="mb-1"><span class="text-yellow-400 font-bold text-xs">${author}:</span> <span class="text-gray-300 text-xs">${m.content}</span></div>`;
            });
            list.scrollTop = list.scrollHeight;
        }

        async function sendChat() {
            const content = document.getElementById('chat-input').value;
            if(!content) return;
            await client.from('chat_messages').insert({
                content, user_id: state.user?.id || null, guest_nickname: state.user ? null : state.guestName
            });
            document.getElementById('chat-input').value = '';
            // [중요] 즉시 갱신
            loadChat();
        }

        function setupRealtime(table, filter, callback) {
            const key = table + (filter || '');
            // 이미 구독중이면 중복 구독 방지 (끊지 않음)
            if(state.realtimeChannels[key]) return; 

            state.realtimeChannels[key] = client.channel(key)
                .on('postgres_changes', { event: '*', schema: 'public', table, filter }, callback)
                .subscribe();
        }

        // 초기화 및 네비게이션
        function init() {
            MU_GONG_TYPES.forEach(m => document.getElementById('mu-gong-select').innerHTML += `<option value="${m.id}">${m.name}</option>`);
            fetchStockTags();
            checkSession();
            navigate('gangho-plaza');
        }

        window.navigate = function(viewId) {
            document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('text-yellow-400','text-gray-500'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('border-yellow-400','border-transparent'));
            
            const activeBtn = document.querySelector(`button[onclick="navigate('${viewId}')"]`);
            if(activeBtn) {
                activeBtn.classList.replace('text-gray-500','text-yellow-400');
                activeBtn.classList.replace('border-transparent','border-yellow-400');
            }

            if (viewId === 'gangho-plaza') renderPosts('posts-list-public', 'public');
            if (viewId === 'stock-board') {
                 if(state.stockTags.length === 0) fetchStockTags();
                 else renderPosts('posts-list-stock', 'stock', state.currentStockName);
            }
            if (viewId === 'secret-inn') renderPosts('posts-list-secret', 'secret');
            if (viewId === 'chat-hall') {
                loadChat();
                // 채팅 페이지 진입 시 실시간 연결
                setupRealtime('chat_messages', null, loadChat);
            }
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.handleAuth = handleAuth;
        window.logout = logout;
        window.savePost = savePost;
        window.handleImageUpload = handleImageUpload;
        window.formatDoc = (cmd) => document.execCommand(cmd, false, null);
        
        window.tryOpenWriteModal = function(type) {
            document.getElementById('post-modal-title').innerText = '비급 작성';
            document.getElementById('new-post-title').value = '';
            document.getElementById('new-post-content').innerHTML = '';
            state.isEditing = false;
            state.postToEdit = null;
            state.currentPostId = null;

            if (!state.user && type !== 'secret') {
                alert('로그인이 필요한 공간입니다.');
                openModal('authModal');
                return;
            }

            const radios = document.getElementsByName('post-type');
            for(let r of radios) { 
                r.checked = (r.value === type); 
                r.disabled = (!state.user && r.value !== 'secret'); 
            }
            
            document.getElementById('mu-gong-area').classList.toggle('hidden', type !== 'public');
            document.getElementById('stock-area').classList.toggle('hidden', type !== 'stock');
            
            if (type === 'stock') document.getElementById('stock-input').value = state.currentStockName;
            
            openModal('newPostModal');
        }
        
        window.togglePostTypeFields = (type) => {
            document.getElementById('mu-gong-area').classList.toggle('hidden', type !== 'public');
            document.getElementById('stock-area').classList.toggle('hidden', type !== 'stock');
        }

        window.openPostEditModal = function(post) {
            state.isEditing = true;
            state.currentPostId = post.id;
            state.postToEdit = post;
            
            document.getElementById('post-modal-title').innerText = '비급 수정';
            document.getElementById('new-post-title').value = post.title;
            document.getElementById('new-post-content').innerHTML = post.content;
            
            const radios = document.getElementsByName('post-type');
            for(let r of radios) r.checked = (r.value === post.type);
            togglePostTypeFields(post.type);
            
            if(post.type === 'stock') document.getElementById('stock-input').value = post.stock_id;
            
            closeModal('postDetailModal');
            openModal('newPostModal');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
    <style>
        body { background-color: #111118; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        #new-post-content { min-height: 150px; padding: 12px; border: 1px solid #374151; background-color: #1f2937; border-radius: 0 0 8px 8px; }
        #new-post-content:focus { outline: none; border-color: #ca8a04; }
        #new-post-content[contenteditable]:empty:before { content: attr(placeholder); color: #6b7280; }
        .editor-toolbar { background-color: #374151; }
        #detail-content img { max-width: 100%; height: auto; border-radius: 8px; }
        #detail-content iframe { max-width: 100%; aspect-ratio: 16/9; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-[#111118]/90 backdrop-blur-md border-b border-gray-800">
        <div class="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
            <h1 class="text-xl font-bold italic text-yellow-500 tracking-tighter cursor-pointer" onclick="navigate('gangho-plaza')">千金門</h1>
            <div id="auth-buttons"></div>
        </div>
        <nav class="flex justify-around border-b border-gray-800 bg-[#151520]">
            <button onclick="navigate('gangho-plaza')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 text-yellow-400 border-yellow-400 transition-colors">강호광장</button>
            <button onclick="navigate('stock-board')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">종목비급</button>
            <button onclick="navigate('chat-hall')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">무림채팅</button>
            <button onclick="navigate('secret-inn')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">암천객잔</button>
        </nav>
    </header>

    <main class="flex-grow max-w-md mx-auto w-full pb-20 p-4">
        <!-- 뷰 영역 -->
        <div id="gangho-plaza" class="app-view"><h2 class="text-xl font-bold text-white mb-4">강호 광장</h2><div class="space-y-4" id="posts-list-public"></div></div>
        <div id="stock-board" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-2">종목 비급 (<span id="current-stock-name">삼성전자</span>)</h2>
            <div id="stock-tabs" class="flex overflow-x-auto space-x-2 pb-3 scroll-hidden"></div>
            <div class="space-y-4 mt-4" id="posts-list-stock"></div>
        </div>
        <div id="chat-hall" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-4">무림 채팅</h2>
            <div id="chat-list" class="bg-[#1f2937] p-3 rounded-lg h-[60vh] overflow-y-auto scroll-hidden mb-4 border border-gray-700"></div>
            <div class="flex gap-2"><input id="chat-input" type="text" class="flex-grow bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white" onkeydown="if(event.key==='Enter') sendChat()"><button onclick="sendChat()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">전송</button></div>
        </div>
        <div id="secret-inn" class="app-view hidden"><h2 class="text-xl font-bold text-white mb-4">암천 객잔 (익명)</h2><div class="space-y-4" id="posts-list-secret"></div></div>

        <!-- Floating Write Button -->
        <button onclick="tryOpenWriteModal(document.querySelector('.app-view:not(.hidden)').id === 'secret-inn' ? 'secret' : 'public')" class="fixed bottom-20 right-6 w-12 h-12 bg-yellow-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl font-bold hover:bg-yellow-500 transition z-50">+</button>
    </main>

    <!-- Modals -->
    <!-- Write Modal -->
    <div id="newPostModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-md p-5 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4"><span id="post-modal-title">비급 작성</span></h3>
            <div class="flex space-x-3 mb-4 text-sm text-gray-300">
                <label><input type="radio" name="post-type" value="public" onchange="togglePostTypeFields('public')" class="mr-1">강호광장</label>
                <label><input type="radio" name="post-type" value="stock" onchange="togglePostTypeFields('stock')" class="mr-1">종목비급</label>
                <label><input type="radio" name="post-type" value="secret" onchange="togglePostTypeFields('secret')" class="mr-1">암천객잔</label>
            </div>
            <div id="stock-area" class="mb-3 hidden"><input type="text" id="stock-input" list="stock-options" class="w-full bg-gray-800 border border-gray-700 text-white p-2 rounded text-sm" placeholder="종목명"><datalist id="stock-options"></datalist></div>
            <div id="mu-gong-area" class="mb-3"><select id="mu-gong-select" class="w-full bg-gray-800 border border-gray-700 text-white p-2 rounded text-sm"></select></div>
            <input id="new-post-title" type="text" placeholder="제목" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-t-lg mb-0 text-sm">
            <div class="editor-toolbar flex gap-2 p-2 bg-gray-700 border-b border-gray-600">
                <button onclick="formatDoc('bold')" class="text-white text-xs px-2 bg-gray-600 rounded">B</button>
                <label class="text-white text-xs px-2 bg-green-700 rounded cursor-pointer">IMG<input type="file" id="image-upload-input" class="hidden" onchange="handleImageUpload()"></label>
            </div>
            <div id="new-post-content" contenteditable="true" placeholder="내용..." class="w-full text-sm text-gray-200 h-40 overflow-y-auto"></div>
            <div class="flex justify-end gap-2 mt-4"><button onclick="closeModal('newPostModal')" class="px-4 py-2 text-sm bg-gray-700 rounded text-gray-300">취소</button><button id="save-post-btn" onclick="savePost()" class="px-4 py-2 text-sm bg-blue-600 rounded text-white font-bold">등록</button></div>
        </div>
    </div>
    
    <!-- Auth/Detail Modals -->
    <div id="authModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div class="bg-[#1a1a2e] w-full max-w-sm p-6 rounded-2xl border border-gray-600"><div class="flex border-b border-gray-600 mb-5"><button id="tab-login" class="flex-1 pb-2 border-b-2 border-yellow-500 text-white" onclick="setAuthMode('login')">로그인</button><button id="tab-signup" class="flex-1 pb-2 text-gray-500" onclick="setAuthMode('signup')">회원가입</button></div><input id="auth-email" type="email" placeholder="이메일" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded mb-3"><input id="auth-password" type="password" placeholder="비밀번호" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded mb-3"><div id="signup-fields" class="hidden"><input id="auth-confirm-password" type="password" placeholder="비밀번호 확인" class="w-full bg-gray-800 text-white p-3 rounded mb-3"><label class="text-xs text-gray-400"><input type="checkbox" id="auth-terms"> 약관 동의</label></div><button id="auth-action-btn" onclick="handleAuth()" class="w-full mt-4 py-3 bg-yellow-600 text-white rounded font-bold">로그인</button><p onclick="closeModal('authModal')" class="text-center text-gray-500 text-xs mt-3 cursor-pointer">닫기</p></div></div>

    <div id="postDetailModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div class="bg-[#1a1a2e] w-full max-w-md h-[80vh] flex flex-col rounded-2xl border border-gray-600"><div class="p-4 border-b border-gray-700"><h3 id="detail-title" class="text-lg font-bold text-white"></h3><div class="flex justify-between text-xs text-gray-400"><span id="detail-author"></span><div><button id="edit-post-btn" class="hidden mr-2 text-cyan-400">수정</button><button id="delete-post-btn" class="hidden mr-2 text-red-400">삭제</button><button onclick="closeModal('postDetailModal')">닫기</button></div></div></div><div class="flex-grow overflow-y-auto p-4 text-sm text-gray-300" id="detail-content"></div><div class="p-3 bg-gray-800"><div id="comments-list" class="max-h-32 overflow-y-auto mb-2"></div><div class="flex gap-2"><input id="comment-input" type="text" class="flex-grow bg-gray-700 text-white text-xs p-2 rounded" onkeydown="if(event.key==='Enter') addComment()"><button onclick="addComment()" class="bg-gray-600 text-white px-3 text-xs rounded">등록</button></div></div></div></div>

    <div id="toast-notification" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 p-3 rounded bg-green-600 text-white text-sm"><span id="toast-message"></span></div>
</body>
</html>


