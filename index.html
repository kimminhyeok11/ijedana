<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²œê¸ˆë¬¸ (åƒé‡‘é–€) - WebP ë³€í™˜, ì—ë””í„°, ì•ˆì „ ì‚­ì œ í†µí•©</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ------------------------------------------------------------------
        // 1. Supabase ì„¤ì • (ì‚¬ìš©ì ì •ë³´ ì ìš©ë¨)
        // ------------------------------------------------------------------
        const SUPABASE_URL = 'https://jdwlcnkcyglfxqbhkseb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impkd2xjbmtjeWdsZnhxYmhrc2ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjQyMzksImV4cCI6MjA3OTk0MDIzOX0.EhigML9NvLJou2DRBm_iNXErmYByU__WZQ26NcdfTaI';
        const STORAGE_BUCKET = 'images';

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ------------------------------------------------------------------
        // 2. ì „ì—­ ìƒíƒœ ë° ìƒìˆ˜ (messageTimer ì œê±°)
        // ------------------------------------------------------------------
        const state = {
            user: null,
            profile: null,
            currentPostId: null,
            postToEdit: null,
            isEditing: false,
            currentStockName: 'ì‚¼ì„±ì „ì', 
            stockTags: [], 
            realtimeChannels: {},
            guestName: `ë‚˜ê·¸ë„¤_${Math.floor(Math.random() * 1000)}`,
            postIdToDelete: null,
            // messageTimer ì œê±°ë¨
        };

        const LEVEL_NAMES = ['ì…ë¬¸ì', 'ì´ˆí•™ì', 'ì‹œì„¸ê²¬ìŠµ', 'ê¸°ë¬¸ì´ˆí•´', 'ìë³¸ë‚´ê³µê°€', 'ê°•í˜¸ì‹œì„¸ê°', 'ì „ëµë¹„ê¸‰ì‚¬', 'ì‹œì¥í˜„ê²½', 'ì´ˆì ˆì •íˆ¬ê°', 'ì ˆì„¸íˆ¬ìê³ ìˆ˜', 'ê¸ˆë£¡ì¥ë¬¸'];
        
        const MU_GONG_TYPES = [
            { id: 'sword', name: 'ì§ˆí’ê²€ë²• (ë‹¨ê¸°)', tag: 'ë‹¨ê¸°', color: 'text-red-500' },
            { id: 'dao', name: 'íƒœê·¹ë„ë²• (ì¥ê¸°)', tag: 'ì¥ê¸°', color: 'text-blue-500' },
            { id: 'auto', name: 'ì˜¤í† ì§„ë²• (ìë™)', tag: 'ìë™', color: 'text-yellow-500' },
        ];
        
        // ------------------------------------------------------------------
        // 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (showMessage í•¨ìˆ˜ ì œê±°)
        // ------------------------------------------------------------------

        function calculateLevel(postCount, commentCount) {
            const score = (postCount || 0) + (commentCount || 0);
            const idx = Math.min(Math.floor(score / 10), LEVEL_NAMES.length - 1);
            return { name: LEVEL_NAMES[idx], color: idx > 5 ? 'text-yellow-400' : 'text-cyan-400' };
        }

        // --- ì¸ì¦ ê´€ë ¨ ---
        async function handleAuth(isSignUp) {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !password) {
                return console.error('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); // showMessage ëŒ€ì²´
            }

            let error;
            if (isSignUp) {
                ({ error } = await client.auth.signUp({ email, password }));
            } else {
                ({ error } = await client.auth.signInWithPassword({ email, password }));
            }

            if (error) {
                console.error(`ì¸ì¦ ì‹¤íŒ¨: ${error.message}`); // showMessage ëŒ€ì²´
            } else {
                console.log('ì„±ê³µì ìœ¼ë¡œ ë¬¸íŒŒì— ì…ë¬¸í–ˆìŠµë‹ˆë‹¤! (ì´ë©”ì¼ í™•ì¸ í•„ìš”í•  ìˆ˜ ìˆìŒ)'); // showMessage ëŒ€ì²´
                closeModal('authModal');
                checkSession();
            }
        }
        
        async function logout() {
            await client.auth.signOut();
            console.log('í•˜ì‚°í–ˆìŠµë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
            state.profile = null;
            state.user = null;
            updateHeaderUI();
            navigate('gangho-plaza');
        }

        async function checkSession() {
            const { data: { session } } = await client.auth.getSession();
            updateAuthState(session);
            // ì¸ì¦ ìƒíƒœ ë³€í™” ë¦¬ìŠ¤ë„ˆëŠ” í•œ ë²ˆë§Œ ì„¤ì •
            client.auth.onAuthStateChange((_event, session) => updateAuthState(session));
        }

        async function updateAuthState(session) {
            state.user = session ? session.user : null;
            if (state.user) {
                const { data } = await client.from('profiles').select('*').eq('id', state.user.id).single();
                if (data) state.profile = data;
            } else {
                state.profile = null;
            }
            updateHeaderUI();
        }

        function updateHeaderUI() {
            const authContainer = document.getElementById('auth-buttons');
            if (state.user) {
                const level = calculateLevel(state.profile?.post_count, state.profile?.comment_count);
                authContainer.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-400 hidden sm:inline">ë ˆë²¨: <span class="${level.color} font-bold">${level.name}</span></span>
                        <span class="text-xs text-gray-400 hidden sm:inline">í™˜ì˜í•©ë‹ˆë‹¤, <span class="text-yellow-400 font-bold">${state.profile?.nickname || 'ë¬¸ë„'}</span>ë‹˜</span>
                        <button onclick="logout()" class="text-xs bg-red-900/50 text-red-200 px-3 py-1 rounded hover:bg-red-900 transition">í•˜ì‚°</button>
                    </div>
                `;
            } else {
                authContainer.innerHTML = `
                    <button onclick="openModal('authModal')" class="text-xs bg-yellow-600 text-white px-3 py-1 rounded font-bold hover:bg-yellow-500 transition shadow-lg animate-pulse">
                        ì…ë¬¸ (ë¡œê·¸ì¸)
                    </button>
                `;
            }
        }

        // ------------------------------------------------------------------
        // 4. ì´ë¯¸ì§€/ë¯¸ë””ì–´ ì²˜ë¦¬ (WebP ë³€í™˜ ë° Storage)
        // ------------------------------------------------------------------

        /**
         * ì´ë¯¸ì§€ íŒŒì¼ì„ WebPë¡œ ë³€í™˜í•˜ê³  Supabase Storageì— ì—…ë¡œë“œ í›„ URLì„ ë°˜í™˜
         */
        async function convertAndUploadImage(file, folderPath) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        // WebP ë³€í™˜ (í’ˆì§ˆ 80%)
                        canvas.toBlob(async (blob) => {
                            if (!blob) {
                                // --- ë””ë²„ê¹… ê°•í™”: WebP ë³€í™˜ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ---
                                console.error('Error: WebP conversion failed. Blob is null. Check browser support.');
                                reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: Blob ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
                                return;
                            }

                            const webpFileName = `${Date.now()}_${Math.random().toString(36).substring(2, 9)}.webp`;
                            const filePath = `${folderPath}/${webpFileName}`;

                            // Supabase Storage ì—…ë¡œë“œ
                            const { data, error } = await client.storage
                                .from(STORAGE_BUCKET)
                                .upload(filePath, blob, { // blob ì‚¬ìš© í™•ì¸ ì™„ë£Œ
                                    cacheControl: '3600',
                                    upsert: false,
                                    contentType: 'image/webp',
                                });

                            if (error) {
                                // --- ë””ë²„ê¹… ê°•í™”: Supabase ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ---
                                console.error('Supabase Storage Upload Error:', error);
                                console.error('Check RLS Policy or Authentication Status (must be logged in).');
                                reject(error);
                            } else {
                                // getPublicUrlì€ ì´ ê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì ˆëŒ€ URLì„ ìƒì„±í•©ë‹ˆë‹¤. (ê²½ë¡œ ì†ì‹¤ ë¬¸ì œ í•´ê²°)
                                const publicUrl = client.storage.from(STORAGE_BUCKET).getPublicUrl(data.path).data.publicUrl;
                                resolve(publicUrl);
                            }
                        }, 'image/webp', 0.8);
                    };
                    img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'));
                    img.src = event.target.result;
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        window.handleImageUpload = async function() {
            // --- ë””ë²„ê¹… ê°•í™”: ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ---
            if (!state.user) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœ: ë¹„ë¡œê·¸ì¸'); // showMessage ëŒ€ì²´
                return;
            }
            
            const fileInput = document.getElementById('image-upload-input');
            const file = fileInput.files[0];
            if (!file) return;
            
            console.log('ì´ë¯¸ì§€ ë³€í™˜ ë° ì—…ë¡œë“œ ì¤‘...'); // showMessage ëŒ€ì²´
            try {
                // Posts ì´ë¯¸ì§€ëŠ” 'posts' í´ë”ì— ì €ì¥
                const publicUrl = await convertAndUploadImage(file, 'posts');
                
                // ì—ë””í„°ì— ì´ë¯¸ì§€ ì‚½ì… (ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ì ìš©)
                const editor = document.getElementById('new-post-content');
                const imgTag = `<img src="${publicUrl}" class="max-w-full h-auto rounded-lg shadow-md my-3" loading="lazy" onerror="this.src='https://placehold.co/400x200/333/fff?text=ì´ë¯¸ì§€+ë¡œë“œ+ì‹¤íŒ¨'">`;
                
                // ì—ë””í„°ì— í¬ì»¤ìŠ¤ë¥¼ ë§ì¶”ê³  ì´ë¯¸ì§€ ì‚½ì…ì„ ì‹œë„í•©ë‹ˆë‹¤. 
                editor.focus();
                document.execCommand('insertHTML', false, imgTag);
                
                console.log('ì´ë¯¸ì§€ ì‚½ì… ì™„ë£Œ.'); // showMessage ëŒ€ì²´
            } catch (error) {
                console.error('ìµœì¢… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„¸í™”
                console.error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message || 'Supabase RLSë‚˜ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}`); // showMessage ëŒ€ì²´
            } finally {
                fileInput.value = ''; // input ì´ˆê¸°í™”
            }
        };

        // --- prompt() ëŒ€ì‹  ëª¨ë‹¬ì„ ë„ìš°ëŠ” í•¨ìˆ˜ ---
        window.openYouTubeModal = function() {
            document.getElementById('youtube-url-input').value = '';
            openModal('youtubeEmbedModal');
        }

        // --- ëª¨ë‹¬ì—ì„œ í˜¸ì¶œë˜ì–´ ì‹¤ì œ ì„ë² ë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ ---
        window.handleYouTubeEmbedFromModal = function() {
            const url = document.getElementById('youtube-url-input').value.trim();
            closeModal('youtubeEmbedModal'); // ëª¨ë‹¬ ë‹«ê¸°

            if (!url) return;

            // YouTube URLì—ì„œ ë™ì˜ìƒ ID ì¶”ì¶œ
            let videoId;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                videoId = match[2];
            } else {
                console.error('ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
                return;
            }

            const embedHtml = `
                <div class="my-4" style="aspect-ratio: 16 / 9; max-width: 100%;">
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen 
                        class="rounded-lg shadow-xl w-full h-full"
                    ></iframe>
                </div>
            `;
            const editor = document.getElementById('new-post-content');
            document.execCommand('insertHTML', false, embedHtml);
            console.log('YouTube ë™ì˜ìƒ ì‚½ì… ì™„ë£Œ.'); // showMessage ëŒ€ì²´
        };
        
        // ------------------------------------------------------------------
        // 5. ê²Œì‹œê¸€ CRUD ë¡œì§ (ì•ˆì „ ì‚­ì œ í¬í•¨)
        // ------------------------------------------------------------------
        
        /**
         * ê²Œì‹œê¸€ì„ ì €ì¥í•˜ê±°ë‚˜ ìˆ˜ì •í•©ë‹ˆë‹¤.
         * state.isEditing ìƒíƒœì— ë”°ë¼ insert ë˜ëŠ” updateë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
         */
        async function savePost() {
            if (!state.user) {
                return console.error('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
            }

            const type = document.querySelector('input[name="post-type"]:checked').value;
            const title = document.getElementById('new-post-title').value;
            const contentHTML = document.getElementById('new-post-content').innerHTML.trim();

            if (!title || !contentHTML) {
                return console.error('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); // showMessage ëŒ€ì²´
            }

            let stockName = null;

            if (type === 'stock') {
                const inputVal = document.getElementById('stock-input').value.trim();
                if (!inputVal) {
                    return console.error('ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
                }
                
                stockName = inputVal;
                // ì¢…ëª© íƒœê·¸ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„± (ìƒì„± ëª¨ë“œì—ì„œë§Œ)
                if (!state.isEditing) {
                    const exists = state.stockTags.find(t => t.name === stockName);
                    if (!exists) {
                        const { error: tagError } = await client.from('stock_tags').insert({ name: stockName });
                        if (tagError) console.error('íƒœê·¸ ìƒì„± ì‹¤íŒ¨:', tagError);
                        else {
                            console.log(`ìƒˆë¡œìš´ ì¢…ëª© [${stockName}]ì´ ê°•í˜¸ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`); // showMessage ëŒ€ì²´
                            await fetchStockTags();
                        }
                    }
                }
            }

            const payload = {
                title, content: contentHTML, type, 
                stock_id: stockName,
                mugong_id: type === 'public' ? document.getElementById('mu-gong-select').value : null,
            };

            let error;
            let successMessage = 'ë¹„ê¸‰ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
            
            if (state.isEditing) {
                // ìˆ˜ì • ëª¨ë“œ: update
                const { error: updateError } = await client.from('posts')
                    .update(payload)
                    .eq('id', state.currentPostId)
                    .eq('user_id', state.user.id); // ë³¸ì¸ ê¸€ë§Œ ìˆ˜ì • ê°€ëŠ¥
                error = updateError;
                successMessage = 'ë¹„ê¸‰ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
            } else {
                // ì‘ì„± ëª¨ë“œ: insert
                payload.user_id = state.user.id;
                const { error: insertError } = await client.from('posts').insert(payload);
                error = insertError;
            }

            if (error) {
                console.error(error);
                console.error(`ë¹„ê¸‰ ${state.isEditing ? 'ìˆ˜ì •' : 'ë“±ë¡'} ì‹¤íŒ¨.`); // showMessage ëŒ€ì²´
            } else {
                console.log(successMessage); // showMessage ëŒ€ì²´
                closeModal('newPostModal');
                
                // ëª¨ë‹¬ ë‹«ê¸° í›„ ìƒíƒœ ì´ˆê¸°í™” ë° UI ë¦¬í”„ë ˆì‹œ
                state.isEditing = false;
                state.postToEdit = null;
                document.getElementById('new-post-title').value = '';
                document.getElementById('new-post-content').innerHTML = '';
                
                // í˜„ì¬ ë·°ë¥¼ ë¦¬í”„ë ˆì‹œí•˜ê±°ë‚˜ ì¢…ëª© ê²Œì‹œíŒìœ¼ë¡œ ì´ë™
                const currentView = document.querySelector('.app-view:not(.hidden)').id;
                if (type === 'stock') {
                    state.currentStockName = stockName; 
                    navigate('stock-board');
                } else {
                    navigate(currentView); // í˜„ì¬ ë·° ìœ ì§€ ë° ë¦¬í”„ë ˆì‹œ
                }
            }
        }
        
        // --- ìˆ˜ì •ë¨: ì‚­ì œ í™•ì¸ ëª¨ë‹¬ì„ ë„ìš°ëŠ” í•¨ìˆ˜ ---
        window.showDeleteConfirm = function() {
            if (!state.currentPostId) return;
            // ì‚­ì œí•  ê²Œì‹œê¸€ì˜ ì œëª©ì„ í™•ì¸ ëª¨ë‹¬ì— í‘œì‹œ
            const title = document.getElementById('detail-title').innerText;
            document.getElementById('confirm-delete-title').innerText = title;
            openModal('deleteConfirmModal');
        }

        // --- ìˆ˜ì •ë¨: ì‹¤ì œ ì‚­ì œ ë¡œì§. DB ì‚­ì œ ì˜¤ë¥˜ ì‹œ ìƒì„¸ ë¡œê·¸ë¥¼ ë‚¨ê¸°ë„ë¡ ê°•í™” ---
        window.deletePost = async function(postId) {
            closeModal('deleteConfirmModal'); // í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
            
            if (!state.user) {
                return console.error('ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
            }

            // 1. Storage íŒŒì¼ ì‚­ì œë¥¼ ìœ„í•œ ê²Œì‹œê¸€ ë‚´ìš© ì¡°íšŒ
            const { data: post, error: fetchError } = await client.from('posts').select('content, user_id').eq('id', postId).single();
            if (fetchError || !post) {
                console.error("ê²Œì‹œê¸€ ì¡°íšŒ ì˜¤ë¥˜:", fetchError);
                return console.error('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
            }
            // RLS ì •ì±…ì´ ìˆì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ í•œ ë²ˆ ë” í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
            if (post.user_id !== state.user.id) {
                 return console.error('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
            }

            // 2. ë‚´ìš©ì—ì„œ ì´ë¯¸ì§€ URL ì¶”ì¶œ ë° Storage íŒŒì¼ ì‚­ì œ (ì•ˆì „ ì‚­ì œ ë¡œì§)
            const content = post.content;
            // Supabase Storage ê²½ë¡œì— ìˆëŠ” ì´ë¯¸ì§€ URLë§Œ í•„í„°ë§
            const imageUrls = [...content.matchAll(/src="([^"]*)"/g)]
                .map(match => match[1])
                .filter(url => url.includes(SUPABASE_URL) && url.includes(`/${STORAGE_BUCKET}/posts/`));

            if (imageUrls.length > 0) {
                const filesToDelete = imageUrls.map(url => {
                    // Supabase URLì—ì„œ 'images/' ì´í›„ì˜ ê²½ë¡œ ì¶”ì¶œ (e.g., 'posts/file_name.webp')
                    const pathIndex = url.indexOf(`/${STORAGE_BUCKET}/`) + `/${STORAGE_BUCKET}/`.length;
                    // ê²½ë¡œ ì¶”ì¶œ: 'posts/file_name.webp?t=...'
                    let path = url.substring(pathIndex);
                    // ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ì œê±°: 'posts/file_name.webp'
                    path = path.split('?')[0]; 
                    return path;
                });
                
                // Supabase Storageì—ì„œ íŒŒì¼ ì‚­ì œ
                const { error: storageError } = await client.storage.from(STORAGE_BUCKET).remove(filesToDelete);
                if (storageError) {
                    console.error('Storage íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜ (DB ì‚­ì œëŠ” ê³„ì† ì§„í–‰):', storageError);
                    console.error('Storage íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨. (ë¡œê·¸ í™•ì¸)'); // showMessage ëŒ€ì²´
                } else {
                    console.log(`Storage íŒŒì¼ ${filesToDelete.length}ê°œ ì‚­ì œ ì™„ë£Œ.`); // showMessage ëŒ€ì²´
                }
            }

            // 3. DB ê²Œì‹œê¸€ ì‚­ì œ (CommentsëŠ” RLS Cascadeë¡œ ìë™ ì‚­ì œë¨)
            const { error: deleteError } = await client.from('posts').delete().eq('id', postId);

            if (deleteError) {
                // --- ìˆ˜ì •ë¨: ìƒì„¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ë¡œê¹… ---
                console.error('ê²Œì‹œê¸€ DB ì‚­ì œ ì˜¤ë¥˜ (RLS ê°€ëŠ¥ì„± ë†’ìŒ):', deleteError);
                console.error(`ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨: ${deleteError.message}. (ë¡œê·¸ í™•ì¸)`); // showMessage ëŒ€ì²´
            } else {
                console.log('ê²Œì‹œê¸€ ë° ê´€ë ¨ ìë£Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
                closeModal('postDetailModal');
                // í˜„ì¬ ë·° ë¦¬í”„ë ˆì‹œ
                const currentView = document.querySelector('.app-view:not(.hidden)').id;
                navigate(currentView);
            }
        };
        
        // ------------------------------------------------------------------
        // 6. ë·° ë° ë„¤ë¹„ê²Œì´ì…˜
        // ------------------------------------------------------------------

        function navigate(viewId) {
            document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-yellow-400', 'border-yellow-400');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            const activeBtn = document.querySelector(`button[onclick="navigate('${viewId}')"]`);
            if (activeBtn) {
                activeBtn.classList.replace('text-gray-500', 'text-yellow-400');
                activeBtn.classList.replace('border-transparent', 'border-yellow-400');
            }

            if (viewId === 'gangho-plaza') renderPosts('posts-list-public', 'public');
            if (viewId === 'stock-board') {
                if(state.stockTags.length === 0) fetchStockTags();
                else renderPosts('posts-list-stock', 'stock', state.currentStockName);
            }
            if (viewId === 'secret-inn') renderPosts('posts-list-secret', 'secret');
            if (viewId === 'chat-hall') loadChat();
        }

        async function fetchStockTags() {
            const { data } = await client.from('stock_tags').select('name').order('created_at', { ascending: true });
            if (data) {
                state.stockTags = data; 
                renderStockTabs();
                renderStockOptions();
            }
        }

        function renderStockTabs() {
             const stockTabs = document.getElementById('stock-tabs');
            stockTabs.innerHTML = '';
            // í˜„ì¬ ì¢…ëª©ì´ íƒœê·¸ ëª©ë¡ì— ì—†ìœ¼ë©´ ì¶”ê°€ (ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ ìƒì„±ëœ ê²½ìš°)
            if (state.currentStockName && !state.stockTags.find(t => t.name === state.currentStockName)) {
                // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ì„ì‹œë¡œ íƒœê·¸ ëª©ë¡ì— ì¶”ê°€ í›„ ë Œë”ë§
                const tempTags = [...state.stockTags, { name: state.currentStockName }];
                
                tempTags.forEach(tag => {
                    const btn = document.createElement('button');
                    const isActive = state.currentStockName === tag.name;
                    btn.className = `px-3 py-1 rounded-full text-xs whitespace-nowrap transition border ${
                        isActive 
                        ? 'bg-green-800 text-white border-green-600 font-bold shadow-md shadow-green-900/50' 
                        : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700 hover:text-gray-200'
                    }`;
                    btn.innerText = tag.name;
                    btn.onclick = () => {
                        state.currentStockName = tag.name;
                        renderStockTabs();
                        renderPosts('posts-list-stock', 'stock', tag.name);
                        document.getElementById('current-stock-name').innerText = tag.name;
                    };
                    stockTabs.appendChild(btn);
                });
            } else {
                 state.stockTags.forEach(tag => {
                    const btn = document.createElement('button');
                    const isActive = state.currentStockName === tag.name;
                    btn.className = `px-3 py-1 rounded-full text-xs whitespace-nowrap transition border ${
                        isActive 
                        ? 'bg-green-800 text-white border-green-600 font-bold shadow-md shadow-green-900/50' 
                        : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700 hover:text-gray-200'
                    }`;
                    btn.innerText = tag.name;
                    btn.onclick = () => {
                        state.currentStockName = tag.name;
                        renderStockTabs();
                        renderPosts('posts-list-stock', 'stock', tag.name);
                        document.getElementById('current-stock-name').innerText = tag.name;
                    };
                    stockTabs.appendChild(btn);
                });
            }
             // ìŠ¤í¬ë¡¤ì„ ë§¨ ì™¼ìª½ìœ¼ë¡œ ì´ë™
             stockTabs.scrollLeft = 0;
        }

        function renderStockOptions() { 
            const dataList = document.getElementById('stock-options');
            dataList.innerHTML = '';
            state.stockTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.name;
                dataList.appendChild(option);
            });
        }
        
        async function fetchPosts(type, stockName = null) {
            let query = client.from('posts')
                .select(`*, profiles:user_id (nickname, post_count, comment_count)`) 
                .eq('type', type)
                .order('created_at', { ascending: false });

            if (stockName) query = query.eq('stock_id', stockName);

            const { data } = await query;
            return data || [];
        }

        async function renderPosts(containerId, type, stockName = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="text-center text-gray-500 py-10">... ë¹„ê¸‰ì„ ë¡œë”© ì¤‘ ...</div>';
            
            const posts = await fetchPosts(type, stockName);
            container.innerHTML = '';

            if (posts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10">ì•„ì§ ë“±ë¡ëœ ë¹„ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</div>';
                return;
            }

            posts.forEach(post => {
                const author = post.profiles?.nickname || post.guest_nickname || 'ìµëª… ë¬¸ë„';
                const level = post.profiles ? calculateLevel(post.profiles.post_count, post.profiles.comment_count) : { name: 'ì…ë¬¸ì', color: 'text-gray-500' };
                const mugong = MU_GONG_TYPES.find(m => m.id === post.mugong_id);

                const postEl = document.createElement('div');
                postEl.className = 'bg-[#1f2937] p-4 rounded-xl shadow-lg border border-gray-700 hover:border-yellow-600 transition cursor-pointer';
                postEl.onclick = () => openPostDetail(post);

                postEl.innerHTML = `
                    <h4 class="text-white font-semibold truncate text-base mb-2">${post.title}</h4>
                    <div class="text-xs text-gray-400 flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <span class="${level.color} font-medium">${level.name}</span>
                            <span class="text-yellow-400">${author}</span>
                            ${mugong ? `<span class="px-2 py-0.5 rounded-full text-[10px] bg-gray-700 ${mugong.color}">${mugong.tag}</span>` : ''}
                        </div>
                        <span class="text-gray-500">${new Date(post.created_at).toLocaleDateString()}</span>
                    </div>
                `;
                container.appendChild(postEl);
            });
        }

        window.openPostDetail = async function(post) {
            state.currentPostId = post.id;
            state.postToEdit = post; // ìˆ˜ì •í•  í¬ìŠ¤íŠ¸ ì •ë³´ ì €ì¥
            const modal = document.getElementById('postDetailModal');
            document.getElementById('detail-title').innerText = post.title;
            
            // HTML ë‚´ìš©ì„ ì‚½ì…í•˜ì—¬ ì´ë¯¸ì§€/ë¹„ë””ì˜¤ê°€ ë Œë”ë§ë˜ë„ë¡ ì²˜ë¦¬
            document.getElementById('detail-content').innerHTML = post.content;
            
            const author = post.profiles?.nickname || post.guest_nickname || 'ìµëª… ë¬¸ë„';
            document.getElementById('detail-author').innerText = author;
            
            const deleteBtn = document.getElementById('delete-post-btn');
            const editBtn = document.getElementById('edit-post-btn'); // ì¶”ê°€ë¨

            if (state.user?.id === post.user_id) {
                deleteBtn.classList.remove('hidden');
                editBtn.classList.remove('hidden'); // ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ
                
                deleteBtn.onclick = () => showDeleteConfirm(); 
                editBtn.onclick = () => openPostEditModal(post); // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
            } else {
                deleteBtn.classList.add('hidden');
                editBtn.classList.add('hidden'); // ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¹€
            }
            
            loadComments(post.id);
            modal.classList.remove('hidden');
        }
        
        /**
         * ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë‹¬ì„ ì—´ê³  ë°ì´í„°ë¥¼ ì±„ì›ë‹ˆë‹¤.
         */
        window.openPostEditModal = function(post) {
            if (!state.user || state.user.id !== post.user_id) {
                return console.error('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
            }
            closeModal('postDetailModal'); // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
            
            state.isEditing = true;
            state.currentPostId = post.id;
            state.postToEdit = post;
            
            // UI ì—…ë°ì´íŠ¸ (ì œëª©, ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½)
            document.getElementById('post-modal-title').innerText = 'ë¹„ê¸‰ ìˆ˜ì •';
            document.getElementById('save-post-text').innerText = 'ìˆ˜ì • ì™„ë£Œ';

            // ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById(`type-${post.type}`).checked = true;
            togglePostTypeFields(post.type);
            document.getElementById('new-post-title').value = post.title;
            document.getElementById('new-post-content').innerHTML = post.content;
            
            if (post.type === 'stock') {
                document.getElementById('stock-input').value = post.stock_id;
            }
            if (post.type === 'public') {
                document.getElementById('mu-gong-select').value = post.mugong_id;
            }

            openModal('newPostModal');
            document.getElementById('new-post-content').focus();
        }


        // ------------------------------------------------------------------
        // 7. ëŒ“ê¸€ ë¡œì§
        // ------------------------------------------------------------------

        async function loadComments(postId) {
            const { data } = await client.from('comments')
                .select(`*, profiles:user_id (nickname, post_count, comment_count)`)
                .eq('post_id', postId)
                .order('created_at', { ascending: true });
            renderComments(data || []);
            setupRealtimeComments(postId);
        }

        function renderComments(comments) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '';
            comments.forEach(comment => {
                const author = comment.profiles?.nickname || comment.guest_nickname || 'ìµëª…';
                const level = comment.profiles ? calculateLevel(comment.profiles.post_count, comment.profiles.comment_count) : { name: 'ì…ë¬¸ì', color: 'text-gray-500' };

                const commentEl = document.createElement('div');
                commentEl.className = 'p-2 rounded-lg bg-gray-700/50';
                commentEl.innerHTML = `
                    <p class="text-[10px] text-gray-400 mb-1">
                        <span class="${level.color}">${level.name}</span>
                        <span class="text-yellow-300 font-medium">${author}</span>
                        <span class="float-right">${new Date(comment.created_at).toLocaleTimeString()}</span>
                    </p>
                    <p class="text-xs text-gray-200">${comment.content}</p>
                `;
                list.appendChild(commentEl);
            });
            list.scrollTop = list.scrollHeight;
        }

        async function addComment() {
            const postId = state.currentPostId;
            const input = document.getElementById('comment-input');
            const content = input.value.trim();
            if (!content || !postId) return;

            const payload = {
                post_id: postId,
                content: content,
                user_id: state.user?.id || null,
                guest_nickname: state.user ? null : state.guestName,
            };

            const { error } = await client.from('comments').insert(payload);
            if (error) {
                console.error(error);
                console.error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨.'); // showMessage ëŒ€ì²´
            } else {
                input.value = '';
            }
        }

        function setupRealtimeComments(postId) {
            if (state.realtimeChannels[`comments_${postId}`]) {
                client.removeChannel(state.realtimeChannels[`comments_${postId}`]);
            }
            const channel = client.channel(`comments_${postId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'comments', filter: `post_id=eq.${postId}` }, 
                    // ëŒ“ê¸€ì´ ì¶”ê°€/ì‚­ì œ/ì—…ë°ì´íŠ¸ë˜ë©´ ëŒ“ê¸€ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ UI ê°±ì‹ 
                    () => loadComments(postId) 
                ).subscribe();
            state.realtimeChannels[`comments_${postId}`] = channel;
        }

        // ------------------------------------------------------------------
        // 8. ì±„íŒ… ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        // ------------------------------------------------------------------

        async function loadChat() {
            const { data } = await client.from('chat_messages')
                .select(`*, profiles:user_id (nickname)`)
                .order('created_at', { ascending: false })
                .limit(50);
            renderChat(data.reverse() || []);
            setupRealtimeChat();
        }

        function renderChat(messages) {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            messages.forEach(msg => {
                const author = msg.profiles?.nickname || msg.guest_nickname || 'ìµëª… ë¬¸ë„';
                const msgEl = document.createElement('div');
                msgEl.className = 'text-xs mb-1';
                msgEl.innerHTML = `<span class="text-yellow-400 font-medium">${author}:</span> <span class="text-gray-300">${msg.content}</span>`;
                chatList.appendChild(msgEl);
            });
            chatList.scrollTop = chatList.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content) return;

            const payload = {
                content: content,
                user_id: state.user?.id || null,
                guest_nickname: state.user ? null : state.guestName,
            };

            const { error } = await client.from('chat_messages').insert(payload);
            if (error) {
                console.error(error);
                console.error('ì±„íŒ… ì „ì†¡ ì‹¤íŒ¨.'); // showMessage ëŒ€ì²´
            } else {
                input.value = '';
            }
        }
        
        function setupRealtimeChat() {
             if (state.realtimeChannels['chat']) {
                client.removeChannel(state.realtimeChannels['chat']);
            }
            const channel = client.channel('chat')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, 
                    () => loadChat()
                ).subscribe();
            state.realtimeChannels['chat'] = channel;
        }


        // ------------------------------------------------------------------
        // 9. ì´ˆê¸°í™” ë° ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        // ------------------------------------------------------------------
        
        /**
         * ëª¨ë‹¬ì„ ë‹«ì„ ë•Œ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ê³  UIë¥¼ ë³µì›í•©ë‹ˆë‹¤.
         */
        window.resetPostModal = function() {
            state.isEditing = false;
            state.postToEdit = null;
            state.currentPostId = null; // currentPostId ì´ˆê¸°í™” (ëŒ“ê¸€ ë¡œë“œì— ì˜í–¥ X)

            document.getElementById('post-modal-title').innerText = 'ë¹„ê¸‰ ì‘ì„±';
            document.getElementById('save-post-text').innerText = 'ë“±ë¡';
            document.getElementById('new-post-title').value = '';
            document.getElementById('new-post-content').innerHTML = '';
            // ë¼ë””ì˜¤ ë²„íŠ¼ ë¹„í™œì„±í™” í•´ì œ
            document.querySelectorAll('input[name="post-type"]').forEach(radio => {
                radio.disabled = false;
            });
            closeModal('newPostModal');
        }

        function init() {
            checkSession();
            const mugongSel = document.getElementById('mu-gong-select');
            MU_GONG_TYPES.forEach(m => mugongSel.innerHTML += `<option value="${m.id}">${m.name}</option>`);

            fetchStockTags();
            navigate('gangho-plaza');
        }

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        // ëª¨ë‹¬ ë‹«ê¸° ì‹œ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ ì—°ê²°
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            if (id === 'newPostModal') {
                resetPostModal();
            }
        };
        window.navigate = navigate;
        window.handleAuth = handleAuth;
        window.logout = logout;
        window.sendChat = sendChat;
        window.addComment = addComment;
        window.deletePost = deletePost;
        window.savePost = savePost;
        window.showDeleteConfirm = showDeleteConfirm; 
        
        window.formatDoc = function(cmd, value = null) {
            document.execCommand(cmd, false, value);
            document.getElementById('new-post-content').focus();
        };

        window.tryOpenWriteModal = function(type) {
            if (!state.user) {
                console.error('ë¹„ê¸‰ ê¸°ë¡ì€ ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); // showMessage ëŒ€ì²´
                openModal('authModal');
                return;
            }
            // ì‘ì„± ëª¨ë“œë¡œ ì´ˆê¸°í™”
            state.isEditing = false; 
            document.getElementById('post-modal-title').innerText = 'ë¹„ê¸‰ ì‘ì„±';
            document.getElementById('save-post-text').innerText = 'ë“±ë¡';

            document.getElementById(`type-${type}`).checked = true;
            togglePostTypeFields(type);
            openModal('newPostModal');
            
            if (type === 'stock') {
                document.getElementById('stock-input').value = state.currentStockName;
            }
             document.getElementById('new-post-content').focus(); // ì—ë””í„° í¬ì»¤ìŠ¤
        };

        window.togglePostTypeFields = (type) => {
            document.getElementById('mu-gong-area').classList.toggle('hidden', type !== 'public');
            document.getElementById('stock-area').classList.toggle('hidden', type !== 'stock');
            // ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” íƒ€ì… ë³€ê²½ì„ ë§‰ê¸° ìœ„í•´ Radio ë²„íŠ¼ì„ ë¹„í™œì„±í™”
            document.querySelectorAll('input[name="post-type"]').forEach(radio => {
                radio.disabled = state.isEditing;
            });
        };

        window.handleYouTubeEmbed = window.openYouTubeModal;
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <style>
        body { background-color: #111118; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        /* ì—ë””í„° ìŠ¤íƒ€ì¼ */
        #new-post-content { min-height: 150px; padding: 12px; border: 1px solid #374151; background-color: #1f2937; border-radius: 0 0 8px 8px; }
        #new-post-content:focus { outline: none; }
        #new-post-content[contenteditable]:empty:before {
            content: attr(placeholder);
            color: #6b7280;
            opacity: 0.6;
            pointer-events: none;
        }
        .editor-toolbar { background-color: #374151; }
        /* ì´ë¯¸ì§€ ì‚½ì… í›„ ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€ ë° ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        #detail-content img { max-width: 100%; height: auto; }
        /* iframe ë°˜ì‘í˜• */
        #detail-content iframe { max-width: 100%; height: auto; }
        /* ì¢…ëª© íƒ­ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼ ì¹œí™”ì ) */
        #stock-tabs { -ms-overflow-style: none; /* IE and Edge */ scrollbar-width: none; /* Firefox */ }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- Message Box (ì œê±°ë¨) -->

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-[#111118]/90 backdrop-blur-md border-b border-gray-800">
        <div class="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
            <h1 class="text-xl font-bold italic text-yellow-500 tracking-tighter cursor-pointer" onclick="navigate('gangho-plaza')">åƒé‡‘é–€</h1>
            <div id="auth-buttons"></div>
        </div>
        <nav class="flex justify-around border-b border-gray-800 bg-[#151520]">
            <button onclick="navigate('gangho-plaza')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 text-yellow-400 border-yellow-400 transition-colors">ê°•í˜¸ê´‘ì¥</button>
            <button onclick="navigate('stock-board')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">ì¢…ëª©ë¹„ê¸‰</button>
            <button onclick="navigate('chat-hall')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">ë¬´ë¦¼ì±„íŒ…</button>
            <button onclick="navigate('secret-inn')" class="nav-btn flex-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 transition-colors">ì•”ì²œê°ì”</button>
        </nav>
    </header>

    <main class="flex-grow max-w-md mx-auto w-full pb-20 p-4">

        <!-- 1. ê°•í˜¸ê´‘ì¥ (Public Posts) -->
        <div id="gangho-plaza" class="app-view">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">ê°•í˜¸ ê´‘ì¥ (ë¬´ê³µ í† ë¡ )</h2>
            <div class="space-y-4" id="posts-list-public"></div>
        </div>

        <!-- 2. ì¢…ëª©ë¹„ê¸‰ (Stock Posts) -->
        <div id="stock-board" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">ì¢…ëª© ë¹„ê¸‰ (<span id="current-stock-name">ì‚¼ì„±ì „ì</span>)</h2>
            
            <!-- Stock Tabs -->
            <div id="stock-tabs" class="flex overflow-x-auto space-x-2 pb-3 scroll-hidden"></div>
            
            <div class="space-y-4 mt-4" id="posts-list-stock"></div>
        </div>

        <!-- 3. ë¬´ë¦¼ ì±„íŒ… (Chat) -->
        <div id="chat-hall" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">ë¬´ë¦¼ ì±„íŒ… (ì‹¤ì‹œê°„ ì¡ë‹´)</h2>
            <div id="chat-list" class="bg-[#1f2937] p-3 rounded-lg h-[60vh] overflow-y-auto scroll-hidden mb-4 border border-gray-700">
                <!-- Chat Messages will be rendered here -->
            </div>
            <div class="flex gap-2">
                <input id="chat-input" type="text" placeholder="ì±„íŒ… ì…ë ¥..." onkeydown="if(event.key==='Enter') sendChat()" class="flex-grow bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white">
                <button onclick="sendChat()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-500">ì „ì†¡</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">* ë¹„ë¡œê·¸ì¸ ì‹œ ì„ì‹œ ë‹‰ë„¤ì„ìœ¼ë¡œ ì°¸ì—¬í•©ë‹ˆë‹¤.</p>
        </div>

        <!-- 4. ì•”ì²œê°ì” (Secret Posts) -->
        <div id="secret-inn" class="app-view hidden">
            <h2 class="text-xl font-bold text-white mb-4 mt-2">ì•”ì²œ ê°ì” (ë¹„ë°€ ê¸€)</h2>
            <div class="space-y-4" id="posts-list-secret"></div>
        </div>

        <!-- Floating Write Button -->
        <button onclick="tryOpenWriteModal('public')" class="fixed bottom-6 right-6 w-12 h-12 bg-yellow-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl font-bold hover:bg-yellow-500 transition z-50">
            +
        </button>
    </main>

    <!-- ------------------------------------------------------------------ -->
    <!-- Modals -->
    <!-- ------------------------------------------------------------------ -->

    <!-- Write/Edit Modal (WYSIWYG ì—ë””í„° ì ìš©) -->
    <div id="newPostModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-md p-5 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4"><span id="post-modal-title">ë¹„ê¸‰ ì‘ì„±</span></h3>
            
            <div class="flex space-x-3 mb-4 text-sm text-gray-300">
                <label class="flex items-center"><input type="radio" name="post-type" id="type-public" value="public" onchange="togglePostTypeFields('public')" class="mr-1">ê°•í˜¸ê´‘ì¥</label>
                <label class="flex items-center"><input type="radio" name="post-type" id="type-stock" value="stock" onchange="togglePostTypeFields('stock')" class="mr-1">ì¢…ëª©ë¹„ê¸‰</label>
                <label class="flex items-center"><input type="radio" name="post-type" id="type-secret" value="secret" onchange="togglePostTypeFields('secret')" class="mr-1">ì•”ì²œê°ì”</label>
            </div>

            <div id="stock-area" class="mb-3 hidden">
                <label class="text-xs text-gray-400 mb-1 block">ì¢…ëª©ëª…</label>
                <input type="text" id="stock-input" list="stock-options" class="w-full bg-gray-800 border border-gray-700 text-white p-2 rounded text-sm placeholder-gray-500" placeholder="ì˜ˆ: ì—”ë¹„ë””ì•„, ë¹„íŠ¸ì½”ì¸...">
                <datalist id="stock-options"></datalist>
                <p class="text-[10px] text-green-500 mt-1">* ëª©ë¡ì— ì—†ëŠ” ì¢…ëª©ì„ ì…ë ¥í•˜ë©´ ìƒˆë¡œìš´ ë¬¸íŒŒ(íƒ­)ê°€ ì°½ì„¤ë©ë‹ˆë‹¤.</p>
            </div>

            <div id="mu-gong-area" class="mb-3 hidden">
                <label class="text-xs text-gray-400 mb-1 block">ì‚¬ìš© ë¬´ê³µ</label>
                <select id="mu-gong-select" class="w-full bg-gray-800 border border-gray-700 text-white p-2 rounded text-sm"></select>
            </div>

            <input id="new-post-title" type="text" placeholder="ì œëª©" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-t-lg mb-0 text-sm">
            
            <!-- Rich Text Editor Toolbar -->
            <div class="editor-toolbar flex flex-wrap gap-2 p-2 rounded-b-none border-b border-gray-700">
                <button onclick="formatDoc('bold')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500 font-bold">B</button>
                <button onclick="formatDoc('italic')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500 italic">I</button>
                <button onclick="formatDoc('underline')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500 underline">U</button>
                <button onclick="formatDoc('insertUnorderedList')" class="text-white px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-500">UL</button>
                
                <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ -->
                <label for="image-upload-input" class="text-white px-2 py-1 text-xs rounded bg-green-700 hover:bg-green-600 cursor-pointer flex items-center">
                    ğŸ–¼ï¸ ì´ë¯¸ì§€ (WebP)
                </label>
                <input type="file" id="image-upload-input" accept="image/*" class="hidden" onchange="handleImageUpload()">
                
                <!-- YouTube ì„ë² ë“œ ë²„íŠ¼ (ìˆ˜ì •ë¨: ëª¨ë‹¬ í˜¸ì¶œ) -->
                <button onclick="openYouTubeModal()" class="text-white px-2 py-1 text-xs rounded bg-red-700 hover:bg-red-600 flex items-center">
                    â–¶ï¸ YouTube
                </button>
            </div>

            <!-- Content Editable Area (placeholder ì†ì„± ì ìš©) -->
            <div id="new-post-content" contenteditable="true" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                class="w-full text-sm text-gray-200 overflow-y-auto">
            </div>

            <div class="flex justify-end gap-2 mt-4">
                <!-- closeModalì— resetPostModal ê¸°ëŠ¥ ì—°ê²° -->
                <button onclick="closeModal('newPostModal')" class="px-4 py-2 text-sm bg-gray-700 rounded-lg text-gray-300">ì·¨ì†Œ</button>
                <button onclick="savePost()" class="px-4 py-2 text-sm bg-blue-600 rounded-lg text-white font-bold hover:bg-blue-500"><span id="save-post-text">ë“±ë¡</span></button>
            </div>
        </div>
    </div>
    
    <!-- Post Detail Modal -->
    <div id="postDetailModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-md h-[80vh] flex flex-col p-0 rounded-2xl border border-gray-600 shadow-2xl overflow-hidden">
            <div class="p-5 border-b border-gray-800 flex-shrink-0">
                <h3 id="detail-title" class="text-lg font-bold text-white mb-2"></h3>
                <div class="flex justify-between items-center text-xs text-gray-500">
                    <div id="detail-author"></div>
                    <div class="flex space-x-3 items-center">
                         <!-- ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€ -->
                         <button id="edit-post-btn" class="hidden text-cyan-400 hover:text-cyan-300 font-bold text-xs" onclick="openPostEditModal(state.postToEdit)">ìˆ˜ì •</button>
                         <!-- ì•ˆì „ ì‚­ì œ ê¸°ëŠ¥ì´ ì—°ê²°ëœ ë²„íŠ¼ (ìˆ˜ì •ë¨: showDeleteConfirm í˜¸ì¶œ) -->
                         <button id="delete-post-btn" class="hidden text-red-500 hover:text-red-400 font-bold text-xs" onclick="showDeleteConfirm()">ì‚­ì œ</button>
                         <button onclick="closeModal('postDetailModal')" class="text-gray-400 hover:text-white">âœ•</button>
                    </div>
                </div>
            </div>
            <!-- HTML ë‚´ìš©ì´ ë Œë”ë§ë  ê³³ -->
            <div class="flex-grow overflow-y-auto p-5 scroll-hidden">
                <div id="detail-content" class="text-sm text-gray-300 post-content-style"></div>
            </div>
            <div class="p-3 bg-[#151520] border-t border-gray-800 flex-shrink-0">
                <div id="comments-list" class="max-h-32 overflow-y-auto mb-3 space-y-2 scroll-hidden"></div>
                <div class="flex gap-2">
                    <input id="comment-input" type="text" placeholder="ëŒ“ê¸€ ì…ë ¥..." onkeydown="if(event.key==='Enter') addComment()" class="flex-grow bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xs text-white">
                    <button onclick="addComment()" class="bg-gray-700 text-white px-3 py-2 text-xs rounded-lg font-bold hover:bg-gray-600">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div id="authModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-sm p-6 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-5 text-center">ë¬¸íŒŒ ì…ë¬¸ (Authentication)</h3>
            <input id="auth-email" type="email" placeholder="ì´ë©”ì¼" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mb-3 text-sm">
            <input id="auth-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mb-5 text-sm">
            <div class="flex gap-3">
                <button onclick="handleAuth(false)" class="flex-1 px-4 py-3 text-sm bg-yellow-600 rounded-lg text-white font-bold hover:bg-yellow-500 transition">ë¡œê·¸ì¸</button>
                <button onclick="handleAuth(true)" class="flex-1 px-4 py-3 text-sm bg-green-600 rounded-lg text-white font-bold hover:bg-green-500 transition">íšŒì›ê°€ì…</button>
            </div>
            <p onclick="closeModal('authModal')" class="text-xs text-gray-500 mt-5 text-center cursor-pointer hover:text-gray-300">ì ì‹œ ë‘˜ëŸ¬ë³´ê¸° (ì°½ ë‹«ê¸°)</p>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal (window.confirm ëŒ€ì²´) -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-xs p-6 rounded-2xl border border-red-600 shadow-2xl text-center">
            <h3 class="text-lg font-bold text-red-400 mb-2">ğŸš¨ ê²½ê³ : ë¹„ê¸‰ ì˜êµ¬ ì‚­ì œ</h3>
            <p class="text-sm text-gray-300 mb-3">ì •ë§ë¡œ ì•„ë˜ ë¹„ê¸‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p id="confirm-delete-title" class="text-base font-semibold text-yellow-400 truncate mb-5"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('deleteConfirmModal')" class="px-4 py-2 text-sm bg-gray-700 rounded-lg text-gray-300">ì·¨ì†Œ</button>
                <!-- confirm ë²„íŠ¼ í´ë¦­ ì‹œ, deletePost í•¨ìˆ˜ì— currentPostIdë¥¼ ì „ë‹¬í•˜ì—¬ ì‹¤í–‰ -->
                <button onclick="deletePost(state.currentPostId)" class="px-4 py-2 text-sm bg-red-600 rounded-lg text-white font-bold hover:bg-red-500">ì‚­ì œ í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- YouTube Embed Input Modal (prompt() ëŒ€ì²´) -->
    <div id="youtubeEmbedModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] w-full max-w-sm p-6 rounded-2xl border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">â–¶ï¸ YouTube ë™ì˜ìƒ ì„ë² ë“œ</h3>
            <input id="youtube-url-input" type="url" placeholder="YouTube URL (ì˜ˆ: https://youtu.be/xxx)" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mb-5 text-sm">
            <div class="flex gap-3 justify-end">
                <button onclick="closeModal('youtubeEmbedModal')" class="px-4 py-2 text-sm bg-gray-700 rounded-lg text-gray-300">ì·¨ì†Œ</button>
                <button onclick="handleYouTubeEmbedFromModal()" class="px-4 py-2 text-sm bg-red-600 rounded-lg text-white font-bold hover:bg-red-500">ì„ë² ë“œ</button>
            </div>
        </div>
    </div>
</body>
</html>

